{"title":"2021MRCTF Re wp","uid":"62c420e89414aa7b4113290b58fef1bf","slug":"2021MRCTF-Re-wp","date":"2021-04-17T03:54:09.000Z","updated":"2021-04-19T13:32:20.165Z","comments":true,"path":"api/articles/2021MRCTF-Re-wp.json","keywords":null,"cover":"https://w.wallhaven.cc/full/x8/wallhaven-x88o53.jpg","content":"<h1 id=\"My-Register\"><a href=\"#My-Register\" class=\"headerlink\" title=\"My Register\"></a>My Register</h1><p>这题我觉得出的非常好，真不错，我都学到了很多，尤其是这种双进程保护，之前其实挺懵逼的，最近可能是自己基础更扎实了，很多概念一点就能通，总体就是父进程创建子进程，根据标记，会走向不同分支，这样还不够刺激，还没达到反调试，我们可以在子进程的代码中强行加入一些异常处理，这样当执行到异常处理时，有调试器时（这时候父进程就是调试器）会将执行权转移到父进程，发送一个信号给父进程，父进程代码中设置了while（true），不断的等待，当信号过来时，根据异常的类型，走向不同的分支，这时候父进程作为调试器是可以操作子进程的寄存器以及内存的，也就意味着，我们可以将子进程某个段或者函数进行加密，当异常处理时，父进程再进行解密，leave爷真有你的哦</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210417120458.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210417120624.png\"></p>\n<p>这里是最骚的，如果你去动调，直接完犊子，这个isDeggerpresent本来检测是父进程还是子进程，一般是子进程才能走这个分支，但是当我们用ida去动调时，父进程因为有了调试器，也就意味着，这个父进程进去了，mmmp，后面我分析就很乱，很懵逼。。这里设计是巧妙的。</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210417120908.png\"></p>\n<p>这里是上面我说的，是负责解密子进程的地方，还有修改rip的地方，之前调试父进程一直有异常，问题就在这里跳过的，跟进子进程</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210417121045.png\"></p>\n<p>差不多就是两个输入，然后创建了一个文件，再继续跟</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210417125943.png\"></p>\n<p>就加密方式，没啥好说的，只是注意一点就是email是不影响最后结果，放下exp</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">#include&lt;cstdio&gt;\n#include&lt;cstring&gt;\n#include&quot;defs.h&quot;\nint main()\n&#123;\n   int dword_4xx[376]&#x3D;&#123;0x0000001D, 0x0000006E, 0x0000004E, 0x0000003F, 0x00000039, 0x0000003A, 0x00000028, 0x00000029, 0x00000017, 0x00000014, 0x00000037, 0x00000046, 0x00000043, 0x00000030, 0x00000011, 0x00000012, 0x0000002D, 0x0000002E, 0x00000002, 0x0000000C, 0x00000030, 0x00000031, 0x00000032, 0x0000003E, 0x00000025, 0x00000026, 0x00000005, 0x00000076, 0x0000005E, 0x0000002D, 0x0000000F, 0x0000000C, 0x0000001D, 0x0000001E, 0x0000003F, 0x0000004C, 0x00000066, 0x00000015, 0x00000038, 0x0000003B, 0x00000015, 0x00000016, 0x00000006, 0x00000075, 0x0000006F, 0x0000001C, 0x00000003, 0x00000000, 0x0000000D, 0x0000007C, 0x0000007F, 0x00000003, 0x00000010, 0x0000006C, 0x0000007A, 0x0000000B, 0x00000005, 0x00000006, 0x0000002A, 0x0000002B, 0x00000021, 0x00000052, 0x0000007D, 0x0000000E, 0x00000050, 0x00000053, 0x0000007F, 0x0000007C, 0x0000005B, 0x0000005A, 0x00000056, 0x00000058, 0x0000006C, 0x00000010, 0x00000006, 0x00000077, 0x00000071, 0x00000072, 0x00000050, 0x00000051, 0x0000007D, 0x0000000E, 0x00000011, 0x00000062, 0x00000078, 0x0000007B, 0x0000006B, 0x00000068, 0x00000076, 0x00000078, 0x0000007E, 0x00000070, 0x00000071, 0x00000070, 0x00000043, 0x00000040, 0x0000005D, 0x00000051, 0x00000046, 0x0000003A, 0x00000005, 0x00000079, 0x00000042, 0x0000004C, 0x00000079, 0x0000007A, 0x00000057, 0x00000026, 0x00000023, 0x0000005F, 0x0000004A, 0x00000044, 0x0000006D, 0x0000006C, 0x0000006C, 0x0000006F, 0x00000049, 0x0000004A, 0x00000066, 0x00000067, 0x00000054, 0x0000005A, 0x0000005E, 0x00000050, 0x00000063, 0x00000062, 0x00000052, 0x00000051, 0x000000BD, 0x000000BE, 0x0000009D, 0x0000009C, 0x000000A9, 0x000000A8, 0x00000097, 0x00000099, 0x000000AD, 0x000000D1, 0x000000C6, 0x000000B7, 0x000000B1, 0x000000B2, 0x00000090, 0x000000E3, 0x000000DC, 0x000000A0, 0x000000B7, 0x000000B9, 0x0000008B, 0x0000008A, 0x000000BB, 0x000000B8, 0x000000A5, 0x000000A6, 0x000000B7, 0x000000B6, 0x00000082, 0x000000F1, 0x000000DD, 0x000000AE, 0x000000BE, 0x000000B0, 0x00000086, 0x0000008A, 0x00000099, 0x000000E8, 0x000000E5, 0x00000096, 0x000000B8, 0x000000B9, 0x000000B4, 0x000000C7, 0x000000E1, 0x00000092, 0x00000080, 0x00000083, 0x0000008D, 0x0000008E, 0x000000A2, 0x000000A3, 0x000000A5, 0x000000A4, 0x000000AB, 0x000000D8, 0x000000F7, 0x00000084, 0x00000094, 0x000000E7, 0x000000F1, 0x00000080, 0x00000083, 0x00000080, 0x000000D0, 0x000000A3, 0x00000081, 0x000000F2, 0x000000E9, 0x000000E8, 0x000000D9, 0x000000D8, 0x000000E6, 0x000000E7, 0x000000D5, 0x000000D6, 0x000000F1, 0x000000F2, 0x000000D1, 0x000000A2, 0x00000093, 0x00000092, 0x00000090, 0x000000E3, 0x000000C4, 0x000000C5, 0x000000C9, 0x000000C8, 0x000000C7, 0x000000C4, 0x000000E7, 0x000000E4, 0x000000C1, 0x000000C0, 0x000000F0, 0x000000F1, 0x000000F0, 0x000000F1, 0x000000FC, 0x0000008F, 0x000000A6, 0x000000D5, 0x000000F8, 0x000000FB, 0x000000D5, 0x000000D6, 0x000000C7, 0x000000B4, 0x0000008D, 0x0000008C, 0x000000A3, 0x000000D0, 0x000000DE, 0x000000DF, 0x000000EC, 0x000000ED, 0x000000E9, 0x000000EA, 0x000000CB, 0x000000BA, 0x000000BA, 0x000000C9, 0x000000E7, 0x00000094, 0x000000B0, 0x000000CC, 0x000000DB, 0x000000D5, 0x0000002E, 0x0000002F, 0x0000002C, 0x0000002F, 0x00000039, 0x0000003A, 0x00000016, 0x00000017, 0x00000017, 0x00000016, 0x00000017, 0x00000019, 0x00000029, 0x00000055, 0x00000041, 0x00000040, 0x00000052, 0x0000002E, 0x00000037, 0x0000003B, 0x00000029, 0x0000002A, 0x00000006, 0x00000075, 0x00000054, 0x00000028, 0x0000003F, 0x00000031, 0x00000030, 0x0000003E, 0x0000003A, 0x00000034, 0x0000000D, 0x0000007E, 0x0000006E, 0x0000001F, 0x00000019, 0x0000001A, 0x00000039, 0x0000004A, 0x00000049, 0x00000048, 0x00000065, 0x00000016, 0x0000003C, 0x0000003D, 0x00000002, 0x0000000C, 0x00000015, 0x00000069, 0x0000007E, 0x0000000F, 0x00000009, 0x0000000A, 0x0000002B, 0x00000058, 0x00000074, 0x00000007, 0x00000016, 0x00000018, 0x00000019, 0x00000017, 0x0000002F, 0x0000002E, 0x0000006D, 0x0000001E, 0x00000000, 0x00000071, 0x00000079, 0x0000007A, 0x0000006A, 0x00000019, 0x00000004, 0x00000077, 0x00000064, 0x00000017, 0x0000000F, 0x00000073, 0x0000006A, 0x00000064, 0x0000004D, 0x0000004C, 0x00000042, 0x00000041, 0x00000069, 0x00000018, 0x0000001B, 0x0000001A, 0x0000001B, 0x0000001A, 0x00000016, 0x00000065, 0x00000042, 0x0000004C, 0x0000007A, 0x00000006, 0x0000002D, 0x0000002C, 0x0000002E, 0x0000005F, 0x00000059, 0x0000005A, 0x00000076, 0x00000077, 0x00000075, 0x0000007B, 0x0000004E, 0x00000040, 0x00000073, 0x00000000, 0x00000021, 0x00000052, 0x00000060, 0x0000006E, 0x00000056, 0x0000002A, 0x00000036, 0x00000047, 0x0000004B, 0x00000078&#125;;\n\n    for(int i&#x3D;374;i&gt;&#x3D;0;i--)\n    &#123;\n        dword_4xx[i]&#x3D;(char)dword_4xx[i]^(char)dword_4xx[i+1]^i;\n    &#125;\n    unsigned __int8 v20;\n    unsigned __int8 v19;\n    unsigned __int8 v18;\n    dword_4xx[375]&#x3D;0x78;\n    char v10[96];\n    char res1[500]&#x3D;&#123;0&#125;;\n    strcpy(v10,&quot;ABCDEFGH&quot;);\n    strcpy(&amp;v10[9],&quot;12345678&quot;);\n    strcpy(&amp;v10[18],&quot;0IJKLMNO&quot;);\n    strcpy(&amp;v10[27],&quot;+OPQRStu&quot;);\n    strcpy(&amp;v10[36],&quot;\\\\vwxyzTU&quot;);\n    strcpy(&amp;v10[45],&quot;abcdefgh&quot;);\n    strcpy(&amp;v10[54],&quot;VWXYZijk&quot;);\n    strcpy(&amp;v10[63],&quot;lmnopqrs&quot;);\n    int ccc&#x3D;0;\n    for(int i&#x3D;0;i&lt;&#x3D;374;i+&#x3D;2)\n    &#123;\n        for(int j&#x3D;0;j&lt;255;j++)\n        &#123;\n            v20&#x3D;(j&gt;&gt;6)&amp;1;\n            v19&#x3D;(j&gt;&gt;3)&amp;7;\n            v18&#x3D;j&amp;7;\n            if(v10[9*v20+v19]&#x3D;&#x3D;dword_4xx[i]&amp;&amp;v10[9*v19+v18]&#x3D;&#x3D;dword_4xx[i+1])\n            &#123;\n              res1[i&#x2F;2]&#x3D;j;\n              ccc+&#x3D;1;\n              break;\n            &#125;\n        &#125;\n    &#125;\n    \n    printf(&quot;%s&quot;,res1);\n    printf(&quot;%d&quot;,ccc);\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">c &#x3D; &quot;4d#52#e2#188#2b0#4b3#7a6#c8d#14a1#218d#36a7#5864#8f80#e843#17827#2609d#3d926#63a38#a13c5#104e5c#1a6252#2ab122#4513b3#6fc534#b4d955#1249eb9#1d9786d#2fe179d#4d7906b#7d5a841#cad38cd#1482e18b#&quot;\ntt&#x3D;c.split(&quot;#&quot;)\ntt&#x3D;tt[:-1]\nprint(int(&quot;0x&quot;+tt[0],16))\nflag&#x3D;chr(0x4d)+chr(0x52)\nprint(tt)\nfor i in range(2,len(tt)):\n    tempSum&#x3D;int(&quot;0x&quot;+tt[i-1],16)+int(&quot;0x&quot;+tt[i-2],16)\n    tempSxm&#x3D;int(&quot;0x&quot;+tt[i],16)\n    flag+&#x3D;chr(tempSxm-tempSum)\nprint(flag)\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h1 id=\"dynnamic-debug\"><a href=\"#dynnamic-debug\" class=\"headerlink\" title=\"dynnamic_debug\"></a>dynnamic_debug</h1><p>意思是动态调试，那就动调呗，按之前的经验就是f7就完事了，到一些关键地方，基本就解密完成了，这题也一样</p>\n<p>然后就是tea加密，很常规，key拿到之后，解密就完事了</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">#include &lt;cstdio&gt;\n#include &lt;cstring&gt;\n#include &quot;defs.h&quot;\n#include&lt;iostream&gt;\n  \n&#x2F;&#x2F;加密函数  \nvoid encrypt (uint32_t* v, uint32_t* k) &#123;  \n    uint32_t v0&#x3D;v[0], v1&#x3D;v[1], sum&#x3D;0, i;           &#x2F;* set up *&#x2F;  \n    uint32_t delta&#x3D;0x9e3779b9;                     &#x2F;* a key schedule constant *&#x2F;  \n    uint32_t k0&#x3D;k[0], k1&#x3D;k[1], k2&#x3D;k[2], k3&#x3D;k[3];   &#x2F;* cache key *&#x2F;  \n    for (i&#x3D;0; i &lt; 32; i++) &#123;                       &#x2F;* basic cycle start *&#x2F;  \n        sum +&#x3D; delta;  \n        v0 +&#x3D; ((v1&lt;&lt;4) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;5) + k1);  \n        v1 +&#x3D; ((v0&lt;&lt;4) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;5) + k3);  \n    &#125;                                              &#x2F;* end cycle *&#x2F;  \n    v[0]&#x3D;v0; v[1]&#x3D;v1;  \n&#125;  \n&#x2F;&#x2F;解密函数  \nvoid decrypt (uint32_t* v, uint32_t* k) &#123;  \n    uint32_t v0&#x3D;v[0], v1&#x3D;v[1], sum&#x3D;0xC6EF3720, i;  &#x2F;* set up *&#x2F;  \n    uint32_t delta&#x3D;0x9e3779b9;                     &#x2F;* a key schedule constant *&#x2F;  \n    uint32_t k0&#x3D;k[0], k1&#x3D;k[1], k2&#x3D;k[2], k3&#x3D;k[3];   &#x2F;* cache key *&#x2F;  \n    for (i&#x3D;0; i&lt;32; i++) &#123;                         &#x2F;* basic cycle start *&#x2F;  \n        v1 -&#x3D; ((v0&lt;&lt;4) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;5) + k3);  \n        v0 -&#x3D; ((v1&lt;&lt;4) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;5) + k1);  \n        sum -&#x3D; delta;  \n    &#125;                                              &#x2F;* end cycle *&#x2F;  \n    v[0]&#x3D;v0; v[1]&#x3D;v1;  \n&#125;  \n  \nint main()  \n&#123;  \n    uint32_t v[] &#x3D;\n&#123;\n  0x5585A199, 0x7E825D68,0x944D0039, 0x71726943, 0x6A514306, 0x4B14AD00, 0x64D20D3F, 0x9F37DB15&#125;;\n    uint32_t k[4]&#x3D;&#123;0x6B696C69,0x79645F65,0x696D616E,0x67626463&#125;;  \n    &#x2F;&#x2F; v为要加密的数据是两个32位无符号整数  \n    &#x2F;&#x2F; k为加密解密密钥，为4个32位无符号整数，即密钥长度为128位   \n    for(int i&#x3D;0;i&lt;8;i+&#x3D;2)\n    &#123;\n        decrypt(v+i, k);  \n    &#125; \n    \n    printf(&quot;%s&quot;,v); \n    return 0;  \n&#125;  \n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","feature":null,"text":"My Register这题我觉得出的非常好，真不错，我都学到了很多，尤其是这种双进程保护，之前其实挺懵逼的，最近可能是自己基础更扎实了，很多概念一点就能通，总体就是父进程创建子进程，根据标记，会走向不同分支，这样还不够刺激，还没达到反调试，我们可以在子进程的代码中强行加入一些异常...","link":"","photos":[],"count_time":{"symbolsCount":"9.2k","symbolsTime":"8 mins."},"categories":[{"name":"writeup","slug":"writeup","count":8,"path":"api/categories/writeup.json"}],"tags":[{"name":"reverse","slug":"reverse","count":11,"path":"api/tags/reverse.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#My-Register\"><span class=\"toc-text\">My Register</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#dynnamic-debug\"><span class=\"toc-text\">dynnamic_debug</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""},"mapped":true,"prev_post":{"title":"ZUC密码","uid":"3c82e2c97f4021478c0aae078b24ed3b","slug":"ZUC密码","date":"2021-04-19T12:05:24.000Z","updated":"2021-04-19T12:15:12.560Z","comments":true,"path":"api/articles/ZUC密码.json","keywords":null,"cover":"https://w.wallhaven.cc/full/rd/wallhaven-rddgwm.jpg","text":"前言复现mrctf题中，发现有题涉及到zuc密码，这个之前好像有听说过，但是没去细致看过，所以就看了几篇博客，跟了下流程，把算法抄了一遍，加深下影响，去具体背加密流程，我这脑子也记不下，只能是熟悉流程和特征，对应的看了233 源代码#include &lt;iostream&gt...","link":"","photos":[],"count_time":{"symbolsCount":"8.4k","symbolsTime":"8 mins."},"categories":[{"name":"密码学","slug":"密码学","count":1,"path":"api/categories/密码学.json"}],"tags":[{"name":"密码学","slug":"密码学","count":1,"path":"api/tags/密码学.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}},"next_post":{"title":"pikachu靶场-RCE","uid":"e5bc877fa4a0c33bb045786c11ac5c34","slug":"pikachu靶场-RCE","date":"2021-04-16T08:13:55.000Z","updated":"2021-04-16T08:22:50.355Z","comments":true,"path":"api/articles/pikachu靶场-RCE.json","keywords":null,"cover":"https://i0.hdslb.com/bfs/article/a5964363335d93811c9b6e0cb80762ac5f87851d.jpg@1320w_1844h.webp","text":"概述 其实就是没对输入做限制，我们可以构造输入，然后直接在对方的服务器上执行，芜湖 exec ping 用管道符隔开，可以执行两段命令，记住就行 exec eval 执行不了就会报错，所以我们这里直接输入phpinfo();，理论上php上的任意可执行的命令都可以的 ","link":"","photos":[],"count_time":{"symbolsCount":135,"symbolsTime":"1 mins."},"categories":[{"name":"渗透测试","slug":"渗透测试","count":3,"path":"api/categories/渗透测试.json"}],"tags":[{"name":"渗透测试","slug":"渗透测试","count":3,"path":"api/tags/渗透测试.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}}}