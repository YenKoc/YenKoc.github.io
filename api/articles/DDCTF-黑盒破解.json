{"title":"DDCTF 黑盒破解","uid":"17e7f940452dda42feb97fd742be4e95","slug":"DDCTF-黑盒破解","date":"2021-04-22T06:07:05.000Z","updated":"2021-04-22T10:13:22.613Z","comments":true,"path":"api/articles/DDCTF-黑盒破解.json","keywords":null,"cover":"https://th.wallhaven.cc/small/e7/e7z65r.jpg","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>最近在出校赛的题，和csu联合出题，压力还是有的，题目不可能出的太水的，所以我最近的想法，搞点有意思的题，看看vm的几种实现，然后自己写写，感受下，然后开始搞搞开发了，嘿嘿，vm做个开胃菜，之后玩点上次github上看到的东西。</p>\n<h1 id=\"开始分析，ida上号\"><a href=\"#开始分析，ida上号\" class=\"headerlink\" title=\"开始分析，ida上号\"></a>开始分析，ida上号</h1><p>这题vm是属于需要自己构造bytecode的，然后构造得出flag，另一种是给出bytecode，然后根据bytecode的加密流程，把flag逆向出来，第二种我觉得比第一种简单，毕竟程序流程是固定的，我们可以直接实现一个解释器，然后通过bytecode，和逆向出的虚拟机dispatcher，弄出伪代码，然后就可以愉快的逆向了，第一种，就emmm，属于得自己去猜和想，这个程序流程要怎么走，难度更大，这题恰好是第一种，只能耐心推导了。</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422141908.png\"></p>\n<p>sub401E90函数和sub4016BD函数是用来初始化vm环境的，</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422142106.png\"></p>\n<p>基本上是一个大型结构体，这个结构体太大，本来想用ida构造个出来的，后面发现字段太多了，玩不动，这里中间和中午看vm构造，差不多</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422143136.png\"></p>\n<p>同样用一个结构体存储这一个opcode，下面是一个handler，其他就是表的各种操作，直接不看，反正和输入没有任何关系，表中的数据，我们只需要在使用的时候，必然是正确的，dump就完事了，接着往下走</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422144646.png\"></p>\n<p>发现我们的输入，作为上文初始化表的下标，和之前定义的opcode开始作对比，丝毫不慌，我们知道了opcode，直接逆推下标，就知道我们的输入范围是什么，pycharm启动</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\nbyte_603900&#x3D;[\n  0x02, 0x00, 0x00, 0x0E, 0x16, 0x54, 0x20, 0x18, 0x11, 0x45,\n  0x50, 0x59, 0x58, 0x53, 0x00, 0x08, 0x44, 0x2D, 0x46, 0x39,\n  0x00, 0x54, 0x42, 0x01, 0x3C, 0x0F, 0x00, 0x07, 0x17, 0x00,\n  0x56, 0x21, 0x00, 0x37, 0x6D, 0x2B, 0x2A, 0x6E, 0x59, 0x5D,\n  0x47, 0x3A, 0x4A, 0x34, 0x44, 0x48, 0x43, 0x6C, 0x3F, 0x59,\n  0x25, 0x33, 0x55, 0x2F, 0x31, 0x68, 0x27, 0x34, 0x7C, 0x28,\n  0x67, 0x59, 0x00, 0x52, 0x00, 0x26, 0x00, 0x3E, 0x56, 0x4E,\n  0x33, 0x21, 0x45, 0x6D, 0x60, 0x39, 0x46, 0x72, 0x6D, 0x4D,\n  0x54, 0x40, 0x00, 0x74, 0x57, 0x73, 0x72, 0x7A, 0x47, 0x45,\n  0x00, 0x71, 0x00, 0x4A, 0x35, 0x70, 0x3B, 0x36, 0x2E, 0x26,\n  0x2C, 0x6C, 0x4A, 0x00, 0x7C, 0x63, 0x35, 0x57, 0x4D, 0x41,\n  0x43, 0x62, 0x00, 0x68, 0x37, 0x00, 0x5A, 0x6A, 0x6B, 0x7C,\n  0x29, 0x69, 0x4C, 0x70, 0x50, 0x71, 0x26, 0x36, 0x3C, 0x06,\n  0x1B, 0x00, 0x3C, 0x30, 0x00, 0x00, 0x00, 0x4C, 0x0B, 0x4B,\n  0x48, 0x08, 0x54, 0x47, 0x12, 0x09, 0x24, 0x00, 0x00, 0x24,\n  0x40, 0x0D, 0x39, 0x06, 0x5C, 0x2C, 0x1A, 0x2D, 0x0A, 0x38,\n  0x35, 0x37, 0x16, 0x3B, 0x00, 0x24, 0x48, 0x00, 0x49, 0x00,\n  0x37, 0x08, 0x1F, 0x24, 0x45, 0x1D, 0x11, 0x40, 0x2F, 0x4A,\n  0x08, 0x15, 0x00, 0x11, 0x00, 0x1A, 0x22, 0x41, 0x52, 0x5B,\n  0x0B, 0x45, 0x31, 0x19, 0x43, 0x19, 0x1E, 0x0A, 0x21, 0x05,\n  0x4D, 0x59, 0x38, 0x34, 0x09, 0x36, 0x2F, 0x43, 0x02, 0x53,\n  0x12, 0x2F, 0x4C, 0x21, 0x0D, 0x3C, 0x31, 0x2E, 0x37, 0x08,\n  0x30, 0x29, 0x32, 0x2F, 0x00, 0x1A, 0x14, 0x41, 0x53, 0x15,\n  0x21, 0x00, 0x08, 0x13, 0x38, 0x5C, 0x36, 0x3B, 0x50, 0x00,\n  0x2F, 0x1E, 0x57, 0x00, 0x30, 0x2E, 0x0C, 0x2E, 0x37, 0x52,\n  0x1C, 0x33, 0x34, 0x11, 0x38, 0x00\n]\nopcode&#x3D;[0x2A,0x27,0x3e,0x5A,0x3F,0x4E,0x6A,0x2B,0x28]\ninputD&#x3D;[]\nfor j in range(len(opcode)):\n    inputD.append(chr(byte_603900.index(opcode[j])&amp;0xff))\nprint(inputD)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422150402.png\"></p>\n<p>这里有点坑的就是表被改了，具体追溯有点麻烦，直接在对比的地方，下断点把正确的opcode dump下来就算成功了。</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210422150553.png\"></p>\n<p>基本上可以确定我们的输入的范围，就在这个九个字母选择，不同的字母对应不同的handler，这里常规步骤是逆向handler，将handler提取出来，然后尝试还原成伪代码，我们跟进不同的函数走着看，然后把关键步骤，都提取出来，比较直观</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">#  *(_BYTE *)(a1 + 665) &#x3D; *(_BYTE *)(*(_QWORD *)(a1 + 8) + *(int *)(a1 + 288));\n\n# *(_BYTE *)(*(int *)(a1 + 288) + *(_QWORD *)(a1 + 8)) &#x3D; *(_BYTE *)(a1 + 665);\n\n#  *(_BYTE *)(a1 + 665) &#x3D; *(_BYTE *)(a1 + 665) + *(_BYTE *)(a1 + 664) - 33;\n\n#  *(_BYTE *)(a1 + 665) &#x3D; *(_BYTE *)(a1 + 665) - *(_BYTE *)(a1 + 664) + 33;  ++*(_BYTE *)(a1 + 665);\n\n# ++*(_DWORD *)(a1 + 288);\n\n#  --*(_DWORD *)(a1 + 288);\n\n# ++*(_DWORD *)(a1 + 288);   *(_BYTE *)(*(_QWORD *)(a1 + 280) + *(int *)(a1 + 288) + *(_QWORD *)a1) &#x3D; *(_BYTE *)(a1+ 16+ *(int *)(a1 + 288)+ (__int64)*(char *)(a1 + 664)- 48)- 49;\n\n# for ( i &#x3D; 0; *(char *)(a1 + 664) &gt; i; ++i )\n#     ++*(_DWORD *)(a1 + 288);\n# *(_BYTE *)(*(_QWORD *)(a1 + 280) + *(int *)(a1 + 288) + *(_QWORD *)a1) &#x3D; *(_BYTE *)(a1 + 16+ *(int *)(a1 + 288) + (__int64)*(char *)(a1 + 664) - 48)- 49;\n\n#  *(_DWORD *)(a1 + 288) +&#x3D; *(char *)(a1 + 664);\n\n #*(_BYTE *)(a1 + 665) *&#x3D; *(_BYTE *)(a1 + 664);\n#*(_BYTE *)(*(_QWORD *)(a1 + 280) + * (int *)(a1 + 288) +*(_QWORD *)a1) &#x3D; *(_BYTE *)(a1+ * (int *)(a1 + 288)+ (__int64) * (char *)(a1 + 664))- 17;\n\n# *(char *)(a1 + 665) &#x2F;&#x3D; *(char *)(a1 + 664);\n\n#*(_BYTE *)((int)++*(_DWORD *)(a1 + 288) + *(_QWORD *)(a1 + 8)) &#x3D; *(_BYTE *)(a1 + 664);\n#*(_BYTE *)(*(_QWORD *)(a1 + 280) + * (int *)(a1 + 288) +*(_QWORD *)a1) &#x3D; *(_BYTE *)(a1+ 16+ * (int *)(a1 + 288) + (__int64) * (char *)(a1 + 664) - 80)- 81;\n\n# *(_BYTE *)(a1 + 664) &#x3D; *(_BYTE *)(*(_QWORD *)(a1 + 8) + (int)(*(_DWORD *)(a1 + 288))--);\n# *(_BYTE *)(*(_QWORD *)(a1 + 280) + *(int *)(a1 + 288) + *(_QWORD *)a1) &#x3D; *(_BYTE *)(a1+ 16+ *(int *)(a1 + 288) + (__int64)*(char *)(a1 + 664)- 32)- 33<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这样看，太丑了，我们用我们的理解的伪代码弄出来。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#39;$&#39;: tmp&#x3D;data[index]\n&#39;8&#39;: data[index]&#x3D;tmp\n&#39;C&#39;: tmp&#x3D;tmp+input[i]-33\n&#39;t&#39;: tmp&#x3D;tmp-input[i]+33; --tmp\n&#39;0&#39;: index++\n&#39;E&#39;: check\n&#39;u&#39;: index--\n&#39;#&#39;: data[index]&#x3D;input[index+input[i]-48]-49\n&#39;;&#39;: \nfor(int j&#x3D;0;j&lt;input[i];j++)\n\t++index\ndata[index]&#x3D;input[index+input[i]-48]-49<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>check函数，主要就是判断PaF0!&amp;Prv}H{ojDQ#7v=是否转变成Binggo</p>\n<p>接下来就开始构造，P-&gt;B 这里肯定是先取数据，然后处理，然后再塞回去，这里数字由大变小，肯定是选t来处理的。</p>\n<p>基本上就是$t/80，以此类推就完事了。</p>\n<p>这里比较绕的点，在于后面那个将data在第7个字符后面截断的时，需要填入的\\0，这里需要特别构造</p>\n<p>这里构造方式很多，就不多逼逼了，这题真有意思，草，调一天了，舒服了。</p>\n<p>  $t/80$C11111)80$CI80$CX80$Cg80$Cj80#1uuuuuuEs</p>\n","feature":null,"text":"前言最近在出校赛的题，和csu联合出题，压力还是有的，题目不可能出的太水的，所以我最近的想法，搞点有意思的题，看看vm的几种实现，然后自己写写，感受下，然后开始搞搞开发了，嘿嘿，vm做个开胃菜，之后玩点上次github上看到的东西。 开始分析，ida上号这题vm是属于需要自己构造...","link":"","photos":[],"count_time":{"symbolsCount":"4.9k","symbolsTime":"4 mins."},"categories":[{"name":"writeup","slug":"writeup","count":8,"path":"api/categories/writeup.json"}],"tags":[{"name":"reverse","slug":"reverse","count":19,"path":"api/tags/reverse.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BC%80%E5%A7%8B%E5%88%86%E6%9E%90%EF%BC%8Cida%E4%B8%8A%E5%8F%B7\"><span class=\"toc-text\">开始分析，ida上号</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""},"mapped":true,"prev_post":{"title":"2021HW的个人总结","uid":"92105b8d45b62e5c37b36b7d4a309a89","slug":"2021HW的个人总结","date":"2021-04-22T17:50:06.000Z","updated":"2021-04-25T02:00:53.648Z","comments":true,"path":"api/articles/2021HW的个人总结.json","keywords":null,"cover":"https://w.wallhaven.cc/full/rd/wallhaven-rd3pjw.jpg","text":"1.hw给我带来什么？​ 首先，我今年能来护网真的算是我的运气了，至于为什么这么说，因为在面试这个部门的过程中，其实遇到了一些插曲，在一面的时候，回答的还算完美，之前跟着樱花师傅写的os和csapp lab还是有印象的，在二面的时候，就开始崩了，问了很多安卓开发的问题，然而我这里...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"总结","slug":"总结","count":1,"path":"api/categories/总结.json"}],"tags":[{"name":"总结","slug":"总结","count":1,"path":"api/tags/总结.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}},"next_post":{"title":"解决基于多线程栈回溯不够深度，无法定位到具体代码","uid":"a285eb2e1ce3d42c5752f972d9befc34","slug":"解决基于多线程栈回溯不够深度，无法定位到具体代码","date":"2021-04-21T02:05:56.000Z","updated":"2021-04-21T03:17:27.241Z","comments":true,"path":"api/articles/解决基于多线程栈回溯不够深度，无法定位到具体代码.json","keywords":null,"cover":"https://w.wallhaven.cc/full/g8/wallhaven-g83m3d.jpg","text":"前言现在的发包框架都是新起一个线程，然后把一些发包逻辑塞到里面去，之前学习到去hook一些java层的api，可以去栈回溯，但是在实战中发现，就是我们的栈回溯最高层，只能回溯到java.lang.Thread类，但是这个无法让我们快速找到关键代码，而且为什么只能回溯到java.l...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"app抓包","slug":"app抓包","count":1,"path":"api/categories/app抓包.json"}],"tags":[{"name":"抓包","slug":"抓包","count":1,"path":"api/tags/抓包.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}}}