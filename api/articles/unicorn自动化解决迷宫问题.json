{"title":"unicornè‡ªåŠ¨åŒ–è§£å†³è¿·å®«é—®é¢˜","uid":"6946deb52774246dc7e3f9d367660594","slug":"unicornè‡ªåŠ¨åŒ–è§£å†³è¿·å®«é—®é¢˜","date":"2021-08-02T04:11:18.000Z","updated":"2021-08-02T04:27:30.643Z","comments":true,"path":"api/articles/unicornè‡ªåŠ¨åŒ–è§£å†³è¿·å®«é—®é¢˜.json","keywords":null,"cover":[],"content":"<h1 id=\"unicornç®€å•ä½¿ç”¨\"><a href=\"#unicornç®€å•ä½¿ç”¨\" class=\"headerlink\" title=\"unicornç®€å•ä½¿ç”¨\"></a>unicornç®€å•ä½¿ç”¨</h1><p>unicornæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„æ¨¡æ‹Ÿæ‰§è¡Œæ¡†æ¶ï¼Œåœ¨æˆ‘æœ€è¿‘ä½¿ç”¨çœ‹æ¥ï¼Œæ˜¯å…·æœ‰å¯¹å†…å­˜å’ŒæŒ‡ä»¤æœ‰ç€å®Œå…¨æ“çºµæƒçš„æ¡†æ¶ï¼Œå…·æœ‰å¾ˆé«˜çš„å¯å®šåˆ¶åŒ–ï¼Œæ˜¯ä¸€ç§å¤©ç„¶çš„æ²™ç›’</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">from unicorn import *\nfrom unicorn.arm_const import *\nARM_CODE &#x3D; b&quot;\\x37\\x00\\xa0\\xe3\\x03\\x10\\x42\\xe0&quot;\ndef hook_code(uc,address,size,user_data):\n    print(&quot;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size &#x3D; 0x%x&quot;% (address,size))\n\ndef test_arm():\n    print(&quot;Emulate ARM code&quot;)\n    try:\n        mu&#x3D;Uc(UC_ARCH_ARM,UC_MODE_ARM) # åˆ›å»ºä¸€ä¸ªucå¯¹è±¡\n        #map 2MB memory for this emulation  è¿™é‡Œåº”è¯¥æ˜¯ç¬”è¯¯äº†ï¼Œä¸æ˜¯2mbï¼Œ64mbäº†\n        ADDRESS&#x3D;0x10000 # æˆ‘ä»¬éœ€è¦å°†æ‰§è¡Œçš„ä»£ç è½½å…¥unicornçš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œunicornè™šæ‹Ÿæœºå®ä¾‹åˆå§‹å†…å­˜æ˜¯æ²¡æœ‰ä»»ä½•æ˜ å°„çš„ï¼Œåœ¨è¯»å†™å†…å­˜ä¸­ï¼Œä¹Ÿéœ€è¦å…ˆæ˜ å°„ä¸€æ®µå†…å­˜\n        mu.mem_map(ADDRESS,2*0x10000)\n        #å°†ä¹‹å‰ç¼–å†™çš„æŒ‡ä»¤å†™å…¥åˆ°è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå¿…é¡»æ˜¯pythonçš„byteç±»å‹\n        mu.mem_write(ADDRESS,ARM_CODE)\n        #ç»™è™šæ‹Ÿå¯„å­˜å™¨èµ‹å€¼\n        mu.reg_write(UC_ARM_REG_R0,0x1234)\n        mu.reg_write(UC_ARM_REG_R2,0x6789)\n        mu.reg_write(UC_ARM_REG_R3,0x3333)\n        #æ·»åŠ æŒ‡ä»¤çº§çš„hook\n        mu.hook_add(UC_HOOK_CODE,hook_code,begin&#x3D;ADDRESS,end&#x3D;ADDRESS)\n        mu.emu_start(ADDRESS,ADDRESS+len(ARM_CODE))\n        r0&#x3D;mu.reg_read(UC_ARM_REG_R0)\n        r1&#x3D;mu.reg_read(UC_ARM_REG_R1)\n        print(&quot;&gt;&gt;&gt; r0&#x3D;0x%x&quot;%r0)\n        print(&quot;&gt;&gt;&gt; r1&#x3D;0x%x&quot;%r1)\n    except UcError as e:\n        print(&quot;ERROR:%s&quot;%e)\n\ntest_arm()\n# mov r0, #0x37;\n# sub r1, r2, r3\nprint(0x1234)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>æ ¹æ®ä»£ç ç†è§£æ„æ€ï¼Œå®é™…ä¸Šunicornå’Œæˆ‘ä»¬å¸¸è§çš„æœºå™¨æ˜¯ä¸€æ ·ï¼Œä¸è¿‡ä¸€åˆ‡çš„å·¥ä½œéœ€è¦æˆ‘ä»¬è‡ªå·±å¼€å±•äº†ï¼Œæ¯”å¦‚é¡ºåºæ˜¯å…ˆåˆ›å»ºæ¨¡æ‹Ÿå™¨å®ä¾‹ï¼ˆåˆ›å»ºä¸€å°cpuï¼‰ï¼Œå†ç”³è¯·å†…å­˜å’Œæ ˆï¼ˆcpuçš„å¸¸è§„æ“ä½œï¼‰ï¼ŒæŠŠä»£ç åŠ è½½è¿›å†…å­˜ï¼ˆè½½å…¥ï¼‰ï¼Œå®šåˆ¶åŒ–ï¼ŒæŒ‡ä»¤hook or å†…å­˜è®¿é—®hookï¼Œæ‰§è¡Œè½½å…¥ä»£ç ï¼Œæ¥ç®¡ç¨‹åºï¼Œæµç¨‹ç±»ä¼¼ï¼Œç”±äºæˆ‘ä»¬å¯¹å†…å­˜æœ‰å®Œå…¨æ”¯é…ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥é€šè¿‡ä¿®æ”¹å¯„å­˜å™¨æ¥æ§åˆ¶ç¨‹åºæµç¨‹ï¼Œç®€å•ä»‹ç»å®Œï¼Œä¸‹é¢åˆ°æ­£é¢˜</p>\n<h1 id=\"ä»ç¾å›¢ctf-mazeè¿™é¢˜æ¥çœ‹unicornçš„ä½¿ç”¨\"><a href=\"#ä»ç¾å›¢ctf-mazeè¿™é¢˜æ¥çœ‹unicornçš„ä½¿ç”¨\" class=\"headerlink\" title=\"ä»ç¾å›¢ctf mazeè¿™é¢˜æ¥çœ‹unicornçš„ä½¿ç”¨\"></a>ä»ç¾å›¢ctf mazeè¿™é¢˜æ¥çœ‹unicornçš„ä½¿ç”¨</h1><p>è¿™é¢˜å½“åˆæˆ‘æ˜¯ç”¨pintoolsè·‘çš„ï¼Œå¥½å®¶ä¼™ï¼Œæ²¡æŠŠæˆ‘ç´¯æ­»ï¼Œå¤§æ¦‚èŠ±äº†ä¸‰ä¸ªå°æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨åŒ–çš„ğŸ˜­äº†ï¼Œæ‰€ä»¥ç°åœ¨å¾—æŠŠè‡ªåŠ¨åŒ–æèµ·æ¥äº†ï¼ŒåŠªåŠ›å­¦ä¹ ï¼ï¼</p>\n<p>å…ˆä»ä»£ç ç»“æ„æ¥è¯´</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802122027.png\"></p>\n<p>æœ‰ä¸€ç™¾ä¸ªè¿·å®«ï¼Œè¿·å®«é•¿ä»€ä¹ˆæ ·å‘¢</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802122100.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802122118.png\"></p>\n<p>å‘ç°è¿·å®«å‰é¢æ˜¯åœ¨åˆå§‹åŒ–ï¼Œç„¶åæ¯ä¸ªè¿·å®«æ–¹å‘é”®ä¸ä¸€æ ·ï¼ŒåŒæ—¶è¦æ»¡è¶³ifä¸­çš„æ¡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯è‚¯å®šæ˜¯</p>\n<p>æå–å‡º100ä¸ªè¿·å®«å’Œæ–¹å‘é”®ï¼Œåœ¨æœ¬åœ°è·‘dfså¯¹å§ï¼Œé‚£ä¹ˆæ€ä¹ˆå»å®ç°ï¼Œå®Œå…¨å¯ä»¥åŸºäºunicornï¼Œunicornå¯¹å†…å­˜å’Œå¯„å­˜å™¨æœ‰å®Œå…¨æ”¯é…æƒï¼Œè¿·å®«å’Œæ–¹å‘é”®ï¼Œéƒ½åœ¨æ ˆä¸Šï¼Œé‚£å¯¹æˆ‘ä»¬æ¥è¯´ä¸å°±æ˜¯å¾ˆè½»æ¾æå®šå—ï¼Œç„¶åè¿˜éœ€è¦æ‰¾ä¸€ä¸ªæš‚åœç‚¹ï¼Œåœ¨é‚£ä¸ªç‚¹å°±åœä¸‹dumpä¸‹æ•°æ®ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯getcharï¼ˆï¼‰ï¼Œä¸€ä¸ªæ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å¯¼å…¥libcï¼Œå¦ä¸€ä¸ªåŸå› å°±æ˜¯getcharä¼šå…ˆè·³è½¬åˆ°pltè¡¨ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„åœ°ç‚¹ï¼Œå¹¶ä¸ä¼šæ ¹æ®è¿·å®«æ›´æ”¹ï¼Œå®Œå…¨ç¬¦åˆæˆ‘ä»¬è‡ªåŠ¨åŒ–çš„è¦æ±‚ï¼Œä½†æ˜¯è·³åˆ°pltè¡¨ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦æ‰‹åŠ¨leave retï¼Œè¿™é‡Œéœ€è¦å»å¤„ç†ï¼Œå‰©ä¸‹é—®é¢˜å°±æ˜¯rdrandï¼Œè¿™æŒ‡ä»¤unicornæ”¯æŒä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»è·³è¿‡ï¼Œ</p>\n<p>å…¶ä»–å°±æ˜¯å¾ˆå¸¸è§„çš„è„šæœ¬ç¼–å†™ï¼Œå¦å¤–pwntoolsè¿™é‡Œçš„è§£åŒ…ç¨‹åºçœŸä¸é”™ï¼Œu32ï¼Œu64ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å¯ä»¥å°†å­—èŠ‚æµï¼Œè½¬æ¢æˆæ•´æ•°çš„ï¼Œå› ä¸ºunicornå†™å…¥å’Œè¯»å‡ºéƒ½æ˜¯å­—èŠ‚æµï¼Œæ‰€ä»¥u32ï¼Œu64å¤©ç„¶å°±é€‚åˆunicornï¼Œå¾ˆnice</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802122658.png\"></p>\n<p>å‰©ä¸‹å°±æ˜¯æ”¾ä¸‹è„šæœ¬çš„é—®é¢˜äº†</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">from unicorn import *\nfrom unicorn.x86_const import *\nfrom pwn import *\nbaseAddr&#x3D;0\ncodeStart&#x3D;baseAddr\ncodeSize&#x3D;0x100000\nstackStart&#x3D;0x7F00000000\nstackSize&#x3D;0x100000\nfile_code&#x3D;&quot;&quot;\nmainAddr&#x3D;0x00000000000A6AA8\nmainEnd&#x3D;0x00000000000A7344\n#æœ€ç»ˆçš„ç»“æœ\nres&#x3D;&quot;&quot;\nans&#x3D;&quot;&quot;\nstr_dir&#x3D;&quot;&quot;\nmaze_map&#x3D;[]\ndx &#x3D; [0, 0, -1, 1]\ndy &#x3D; [-1, 1, 0, 0]\ndef dfs(f_x,f_y,x,y,i):\n    global ans,dx,dy,str_dir,maze_map\n    if i&#x3D;&#x3D;15:\n        return True\n    for yk in range(4):\n        tmp_x&#x3D;x+dx[yk]\n        tmp_y&#x3D;y+dy[yk]\n        if (0&lt;&#x3D;tmp_x&lt;25) and (0&lt;&#x3D;tmp_y&lt;25) and not (f_x&#x3D;&#x3D;x and f_y&#x3D;&#x3D;y) and (chr(maze_map[25*tmp_y+tmp_x]&amp;0xff)&#x3D;&#x3D;&#39;.&#39;):\n            if dfs(x,y,tmp_x,tmp_y,i+1):\n                ans&#x3D;str_dir[yk]+ans\n                return True\n    return False\ndef hook_code(uc,address,size,user_data):\n    assert isinstance(uc,Uc)\n    global str_dir,maze_map,ans,res\n    cur_map&#x3D;[]\n    cur_code&#x3D;uc.mem_read(address,4)\n        # rdrand()\n    if cur_code&#x3D;&#x3D;b&quot;\\x48\\x0f\\xc7\\xf0&quot;:\n        uc.reg_write(UC_X86_REG_RIP,address+4)\n        # printf()\n    if address&#x3D;&#x3D;0x640:\n        printf_rsp&#x3D;uc.reg_read(UC_X86_REG_RSP)\n        printf_ret_addr&#x3D;u64(uc.mem_read(printf_rsp,8))\n        uc.reg_write(UC_X86_REG_RSP,printf_rsp+8)\n        uc.reg_write(UC_X86_REG_RIP,printf_ret_addr)\n        # getchar() æå–æ•°æ®çš„å…³é”®å‡½æ•°\n    if address&#x3D;&#x3D;0x650:\n        getchar_rsp&#x3D;uc.reg_read(UC_X86_REG_RSP)\n        uc.reg_write(UC_X86_REG_RSP,getchar_rsp+8)\n        getchar_rbp&#x3D;uc.reg_read(UC_X86_REG_RBP)\n        # æ–¹å‘é”®\n        cur_dir&#x3D;uc.mem_read(getchar_rbp-0x9f9,4).decode()\n        cur_map&#x3D;uc.mem_read(getchar_rbp-0xc6a,0x625)\n        xor_map&#x3D;uc.mem_read(getchar_rbp-0x9D0,0x9c4)\n        # èµ·ç‚¹\n        first_y&#x3D;u32(uc.mem_read(getchar_rbp-0x9f0,4))\n        first_x&#x3D;u32(uc.mem_read(getchar_rbp-0x9f4,4))\n        cur_map&#x3D;list(cur_map)\n        for yks in range(0,0x9C4,4):\n            cur_map[yks&#x2F;&#x2F;4]^&#x3D;u32(xor_map[yks:yks+4])\n        for i in range(25):\n            line_data &#x3D; &quot;&quot;\n            for j in range(25):\n                line_data +&#x3D; chr(cur_map[i * 25 + j])\n            print(line_data)\n        str_dir&#x3D;cur_dir\n        maze_map&#x3D;cur_map\n        ans&#x3D;&quot;&quot;\n        dfs(-1,-1,first_x,first_y,0)\n        res+&#x3D;ans\n        cur_rbp&#x3D;uc.reg_read(UC_X86_REG_RBP)\n        cur_rsp&#x3D;uc.reg_read(UC_X86_REG_RSP)\n        new_rbp&#x3D;u64(uc.mem_read(cur_rbp,8))\n        ret_addr&#x3D;u64(uc.mem_read(cur_rbp+8,8))\n        uc.reg_write(UC_X86_REG_RBP,new_rbp)\n        uc.reg_write(UC_X86_REG_RSP,cur_rbp+0x10)\n        uc.reg_write(UC_X86_REG_RIP,ret_addr)\n# åˆå§‹åŒ–unicornçš„ç¯å¢ƒ\ndef init(uc):\n    uc.mem_map(codeStart,codeSize,UC_PROT_ALL)\n    uc.mem_map(stackStart,stackSize,UC_PROT_ALL)\n    #æŠŠä»£ç æ‰”è¿›å»\n    uc.mem_write(codeStart,file_code)\n    #è°ƒæ•´å †æ ˆ\n   # uc.reg_write(UC_X86_REG_RBP,stackStart)\n    uc.reg_write(UC_X86_REG_RSP,stackStart+0x1000)\n    uc.hook_add(UC_HOOK_CODE, hook_code)\nwith open(&quot;100mazes&quot;,&quot;rb&quot;) as e:\n    file_code&#x3D;e.read()\n# åˆ›å»ºucå¯¹è±¡\nuc&#x3D;Uc(UC_ARCH_X86,UC_MODE_64)\n# åˆå§‹åŒ–\ninit(uc)\n# æ·»åŠ æŒ‡ä»¤çš„å›è°ƒ\n\ntry:\n    uc.emu_start(mainAddr, mainEnd)\n    print(res)\nexcept Exception as e:\n    print(e)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","feature":null,"text":"unicornç®€å•ä½¿ç”¨unicornæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„æ¨¡æ‹Ÿæ‰§è¡Œæ¡†æ¶ï¼Œåœ¨æˆ‘æœ€è¿‘ä½¿ç”¨çœ‹æ¥ï¼Œæ˜¯å…·æœ‰å¯¹å†…å­˜å’ŒæŒ‡ä»¤æœ‰ç€å®Œå…¨æ“çºµæƒçš„æ¡†æ¶ï¼Œå…·æœ‰å¾ˆé«˜çš„å¯å®šåˆ¶åŒ–ï¼Œæ˜¯ä¸€ç§å¤©ç„¶çš„æ²™ç›’ from unicorn import * from unicorn.arm_const import * ARM_CO...","link":"","photos":[],"count_time":{"symbolsCount":"5.5k","symbolsTime":"5 mins."},"categories":[{"name":"unicorn","slug":"unicorn","count":1,"path":"api/categories/unicorn.json"}],"tags":[{"name":"reverse","slug":"reverse","count":19,"path":"api/tags/reverse.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#unicorn%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">unicornç®€å•ä½¿ç”¨</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%8E%E7%BE%8E%E5%9B%A2ctf-maze%E8%BF%99%E9%A2%98%E6%9D%A5%E7%9C%8Bunicorn%E7%9A%84%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">ä»ç¾å›¢ctf mazeè¿™é¢˜æ¥çœ‹unicornçš„ä½¿ç”¨</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""},"mapped":true,"prev_post":{},"next_post":{"title":"unidbgåollvmå­—ç¬¦ä¸²æ··æ·†(äºŒ)","uid":"826b11e5304e0be8ab8c923b8486f9df","slug":"unidbgåollvmå­—ç¬¦ä¸²æ··æ·†-äºŒ","date":"2021-08-01T10:21:28.000Z","updated":"2021-08-01T10:31:42.498Z","comments":true,"path":"api/articles/unidbgåollvmå­—ç¬¦ä¸²æ··æ·†-äºŒ.json","keywords":null,"cover":"https://w.wallhaven.cc/full/kw/wallhaven-kwjd76.jpg","text":"å‰è¨€æœ‰ç¢°åˆ°è¿‡ollvmçš„å­—ç¬¦ä¸²åŠ å¯†ï¼Œå¾ˆå¸¸è§çš„ç‰¹å¾å°±åœ¨äºåœ¨initæˆ–è€…init arrayæ®µé‡Œé¢ä¼šæœ‰å¾ˆå¤šå­—ç¬¦ä¸²è§£å¯†çš„å‡½æ•°ï¼Œå¯¹æŠ—çš„æ‰‹æ³•ä¹Ÿæ˜¯å¾ˆå¤šç§çš„ï¼ŒåŠ è½½å†…å­˜dumpï¼Œæˆ–è€…æ¨¡æ‹Ÿæ‰§è¡Œpatchæ‰ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨æ¨¡æ‹Ÿæ‰§è¡Œunidbgæ¥hookå‡ºæ¯æ¬¡å­—ç¬¦ä¸²è§£å¯†å†™å…¥çš„å†…å­˜åœ°å€ä»¥åŠvalue ä»£...","link":"","photos":[],"count_time":{"symbolsCount":"7.1k","symbolsTime":"6 mins."},"categories":[{"name":"unidbg","slug":"unidbg","count":2,"path":"api/categories/unidbg.json"}],"tags":[{"name":"reverse","slug":"reverse","count":19,"path":"api/tags/reverse.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}}}