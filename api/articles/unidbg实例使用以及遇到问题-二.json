{"title":"unidbg实例使用以及遇到问题(二)","uid":"0a9bba8c51d72fa01402e2dedfe71c2c","slug":"unidbg实例使用以及遇到问题-二","date":"2021-08-02T12:38:54.000Z","updated":"2021-08-04T13:24:40.946Z","comments":true,"path":"api/articles/unidbg实例使用以及遇到问题-二.json","keywords":null,"cover":"https://w.wallhaven.cc/full/y8/wallhaven-y855yl.jpg","content":"<h1 id=\"目标锁定\"><a href=\"#目标锁定\" class=\"headerlink\" title=\"目标锁定\"></a>目标锁定</h1><p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802205554.png\"></p>\n<h1 id=\"开始编写unidbg代码看看会报什么错\"><a href=\"#开始编写unidbg代码看看会报什么错\" class=\"headerlink\" title=\"开始编写unidbg代码看看会报什么错\"></a>开始编写unidbg代码看看会报什么错</h1><pre class=\"line-numbers language-none\"><code class=\"language-none\">package pdd;\nimport com.github.unidbg.AndroidEmulator;\nimport com.github.unidbg.Module;\nimport com.github.unidbg.linux.android.AndroidEmulatorBuilder;\nimport com.github.unidbg.linux.android.AndroidResolver;\nimport com.github.unidbg.linux.android.dvm.AbstractJni;\nimport com.github.unidbg.linux.android.dvm.DalvikModule;\nimport com.github.unidbg.linux.android.dvm.VM;\nimport com.github.unidbg.memory.Memory;\nimport com.shuzilm.OnSSChanged;\n\nimport java.io.File;\n\npublic class Pdds extends AbstractJni&#123;\n    private final AndroidEmulator emulator;\n    private final VM vm;\n    private final Module module;\n    public Pdds()\n    &#123;\n        emulator&#x3D; AndroidEmulatorBuilder.for32Bit().build();\n        &#x2F;&#x2F;2. 绑定IO重定向接口\n        &#x2F;&#x2F;emulator.getSyscallHandler().addIOResolver(this);\n        System.out.println(&quot;当前进程pid:&quot;+emulator.getPid());\n        final Memory memory&#x3D; emulator.getMemory();\n        memory.setLibraryResolver(new AndroidResolver(23));\n\n        vm&#x3D;emulator.createDalvikVM(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;120_2b38cee52e87d55c632643a9d8b7d52b.apk&quot;));\n        vm.setVerbose(true); &#x2F;&#x2F;打印jni调用细节\n        &#x2F;&#x2F;new AndroidModule(emulator,vm).register(memory);\n        DalvikModule dm&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libpdd_secure.so&quot;),true);\n        module&#x3D;dm.getModule();\n        vm.setJni(this); &#x2F;&#x2F;设置jni接口\n        dm.callJNI_OnLoad(emulator);\n    &#125;\n\n    public static void main(String[] args) &#123;\n        Pdds ss&#x3D;new Pdds();\n    &#125;\n&#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>运行一手</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802205814.png\"></p>\n<p>发现报了很多错，我们一个一个来解决，大体是三个错误</p>\n<ol>\n<li>缺少libUserEnv.so</li>\n<li>jni version 不合法</li>\n<li>AbstractJNI中的报错，java环境缺失</li>\n</ol>\n<h1 id=\"缺少libUserEnv-so\"><a href=\"#缺少libUserEnv-so\" class=\"headerlink\" title=\"缺少libUserEnv.so\"></a>缺少libUserEnv.so</h1><p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802210034.png\"></p>\n<p>发现确实是依赖这个libUserEnv.so，我们的虚拟内存中也是没有的</p>\n<p>查一下这个so是系统库吗</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802210256.png\"></p>\n<p>并不是，那么说明就是apk本身的so文件，我们找一下</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802210343.png\"></p>\n<p>记载进入看看</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">package pdd;\nimport com.github.unidbg.AndroidEmulator;\nimport com.github.unidbg.Module;\nimport com.github.unidbg.linux.android.AndroidEmulatorBuilder;\nimport com.github.unidbg.linux.android.AndroidResolver;\nimport com.github.unidbg.linux.android.dvm.AbstractJni;\nimport com.github.unidbg.linux.android.dvm.DalvikModule;\nimport com.github.unidbg.linux.android.dvm.VM;\nimport com.github.unidbg.memory.Memory;\nimport com.shuzilm.OnSSChanged;\n\nimport java.io.File;\n\npublic class Pdds extends AbstractJni&#123;\n    private final AndroidEmulator emulator;\n    private final VM vm;\n    private final Module module;\n    public Pdds()\n    &#123;\n        emulator&#x3D; AndroidEmulatorBuilder.for32Bit().build();\n        &#x2F;&#x2F;2. 绑定IO重定向接口\n        &#x2F;&#x2F;emulator.getSyscallHandler().addIOResolver(this);\n        System.out.println(&quot;当前进程pid:&quot;+emulator.getPid());\n        final Memory memory&#x3D; emulator.getMemory();\n        memory.setLibraryResolver(new AndroidResolver(23));\n\n        vm&#x3D;emulator.createDalvikVM(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;120_2b38cee52e87d55c632643a9d8b7d52b.apk&quot;));\n        vm.setVerbose(true); &#x2F;&#x2F;打印jni调用细节\n        &#x2F;&#x2F;new AndroidModule(emulator,vm).register(memory);\n        DalvikModule dm_libUserEnv&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libUserEnv.so&quot;),true);\n        dm_libUserEnv.callJNI_OnLoad(emulator);\n        DalvikModule dm&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libpdd_secure.so&quot;),true);\n        module&#x3D;dm.getModule();\n        vm.setJni(this); &#x2F;&#x2F;设置jni接口\n\n        dm.callJNI_OnLoad(emulator);\n    &#125;\n\n    public static void main(String[] args) &#123;\n        Pdds ss&#x3D;new Pdds();\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>发现出现了新的报错，原来是libUserEnv也依赖了其他库，如果按安卓方法载入的话就会遇到这种尴尬的操作2333</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802211136.png\"></p>\n<p>那么继续导入这个库，哦对，依赖库必须比本身的库要更早加载</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">package pdd;\nimport com.github.unidbg.AndroidEmulator;\nimport com.github.unidbg.Module;\nimport com.github.unidbg.linux.android.AndroidEmulatorBuilder;\nimport com.github.unidbg.linux.android.AndroidResolver;\nimport com.github.unidbg.linux.android.dvm.AbstractJni;\nimport com.github.unidbg.linux.android.dvm.DalvikModule;\nimport com.github.unidbg.linux.android.dvm.VM;\nimport com.github.unidbg.memory.Memory;\nimport com.shuzilm.OnSSChanged;\n\nimport java.io.File;\n\npublic class Pdds extends AbstractJni&#123;\n    private final AndroidEmulator emulator;\n    private final VM vm;\n    private final Module module;\n    public Pdds()\n    &#123;\n        emulator&#x3D; AndroidEmulatorBuilder.for32Bit().build();\n        &#x2F;&#x2F;2. 绑定IO重定向接口\n        &#x2F;&#x2F;emulator.getSyscallHandler().addIOResolver(this);\n        System.out.println(&quot;当前进程pid:&quot;+emulator.getPid());\n        final Memory memory&#x3D; emulator.getMemory();\n        memory.setLibraryResolver(new AndroidResolver(23));\n\n        vm&#x3D;emulator.createDalvikVM(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;120_2b38cee52e87d55c632643a9d8b7d52b.apk&quot;));\n        vm.setVerbose(true); &#x2F;&#x2F;打印jni调用细节\n        vm.setJni(this); &#x2F;&#x2F;设置jni接口\n\n        &#x2F;&#x2F;new AndroidModule(emulator,vm).register(memory);\n        DalvikModule dm_libc_shared&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libc++_shared.so&quot;),true);\n        dm_libc_shared.callJNI_OnLoad(emulator);\n        DalvikModule dm_libUserEnv&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libUserEnv.so&quot;),true);\n        dm_libUserEnv.callJNI_OnLoad(emulator);\n        DalvikModule dm&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libpdd_secure.so&quot;),true);\n        module&#x3D;dm.getModule();\n\n        dm.callJNI_OnLoad(emulator);\n    &#125;\n\n    public static void main(String[] args) &#123;\n        Pdds ss&#x3D;new Pdds();\n    &#125;\n&#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>现在的报错</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802211555.png\"></p>\n<p>再继续补环境</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802211946.png\"></p>\n<p>看下这句的含义，调用getStaticObjectField ,调用的是android/provider/Setting$Secure类的ANDROID_ID字段值，返回值是字符串类型</p>\n<p>怎么去解决这个问题</p>\n<ol>\n<li>native通过jni接口去调用java层的东西，需要去知道调用的是什么类，什么字段</li>\n<li>这个东西在unidbg中怎么去做传递和返回的</li>\n</ol>\n<p>先看一手unidbg本身是怎么实现jni接口，翻看源码大法</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802215202.png\"></p>\n<p>发现是unidbg其实只针对SystemService类实现了，常见的几种字段获取，所以如果模拟执行调用这个jni接口，一旦我们的签名不在其中，那么报错是理所当然的，那么我们其实也可以在unidbg源码中加入我们的逻辑，然后返回值</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802215609.png\"></p>\n<p>这时候再次运行看看</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802215657.png\"></p>\n<p>发现这个报错解决了，不过仔细想想，这是什么狗屁代码，因为一个系统类的字段，然后在源码中加入了一段，兼容太垃圾了，根本就不推荐，这也是为什么作者只实现部分代码的原因。</p>\n<p>这里选择在本类中，重写这个方法，保证代码的移植性</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802220155.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802222019.png\"></p>\n<p>发现又出现一个报错，似乎和之前一样的，继续去源码中看看</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802222104.png\"></p>\n<p>这里之前就有一个类似的，那么我们可以参考这里写法，直接copy，然后在本类中实现</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802222419.png\"></p>\n<p>再次运行</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210802222535.png\"></p>\n<p>引入思考，为什么这里的代码套了三个resolveclass，如果没有参考的话，我们应该怎么去写这种代码，</p>\n<p>两个问题:</p>\n<p>1.callObjectMethodV或者之前的getStaticObjectField，返回都是object，unidbg如何构造jobject</p>\n<p>2.jstring在unidbg被封装成了StringObject，除此之外，下图中标准的jobject都是已经被封装好了</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210803221350.png\"></p>\n<p>在unidbg源码中</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210803221645.png\"></p>\n<p>那么unidbg中没有的jobject该怎么处理，我们可以通过如下方式</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">return vm.resolveClass(&quot;xx&#x2F;xx&#x2F;xx&#x2F;xx&quot;).newObject(null);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p> resolveClass 创建目标类，newObject创建实例，newobject参数一般为null即可，这样就创建了一个目标类的实例jobject。一般还会将signature签名填入newObject，用于区分object，方便后续的分别处理。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">return vm.resolveClass(&quot;xx&#x2F;xx&#x2F;xx&#x2F;xx&quot;).newObject(signature);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>但是这里确填写了相当复杂的东西</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">return vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;,vm.resolveClass(&quot;android&#x2F;content&#x2F;ContextAWrapper&quot;)))).newObject(signature);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>那么如果我们拆开来看</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">DvmClass context&#x3D;vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;)\nDvmClass ContextWrapper&#x3D;vm.resolveClass(&quot;android&#x2F;content&#x2F;ContextWrapper&quot;,context);\nDvmClasss Application&#x3D;vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;,ContextWrapper);\nreturn Application.newObject(signature);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>实际上这就是继承关系.</p>\n<p>Application继承ContextWrapper,ContextWrapper继承Context</p>\n<p>那么得明确两点了</p>\n<ul>\n<li>这个继承关系怎么来</li>\n<li>为什么要明确继承关系</li>\n</ul>\n<p>第一点问题的答案很简单—这个继承关系是Android系统中Application本身的继承关系</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210803223539.png\"></p>\n<p>第二点为什么unidbg表明这个继承关系</p>\n<p>如果不继承的话会怎么样，</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210803224437.png\"></p>\n<p>开始报了一个新错误，可以跟到源码看看</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804105329.png\"></p>\n<p>说明这里dvmMethod为空了，也就是dvmClass.getMethod返回值为空了，找不到method了，那么我们打印一个日志看看</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804112306.png\"></p>\n<p>这里有个坑的地方，就是Logger这个类有好几个文件有定义，选择下图的logger</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804112346.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804122138.png\"></p>\n<p>打印出详细的log。</p>\n<p>从常规的jni开发来说，一般就是findClass，找到类对象，再通过类对象，找到方法的methodID，再通过callxxmethod来进行调用，第一个参数是jobject（打个比方，如果是static的话，就是jclass），第二个参数就是methodID,第三个参数就是输入，那么看这里的话</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804123339.png\"></p>\n<p>这里methodid，还是context类的methodid，毕竟application的方法是从context方法继承来的，java中是这样的，那么我们去看下unidbg中的getMethodID怎么实现的</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804124032.png\"></p>\n<p>发现unidbg的机制是给每个类都生成一个hashmap，并把signature的hashcode作为key，生成一个DvmMethod对象为值，存储起来，那么再看看unidbg类是如何查找method的</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804124755.png\"></p>\n<p>发现调用method时，也是从hashmap中查找，如果本类找不到就去超类中查找，所以我们实现继承关系是为了DvmMethod的查找呀，application没继承的话，在它自身的hashmap是无法找到的233，所以为了防止后面出问题，最好还是把继承关系弄上比较好，那么实际上，我们在调试的过程中是否还需要去把继承关系完全弄上了，似乎并不要，为什么呢，实际上abstrjni把继承链做好了，是一层一层往上的，那么我们可以这样只继承爷爷，不继承爸爸，在没用爸爸方法的情况下，对吧，或者只继承爸爸，不继承爷爷都是没问题的。</p>\n<p>现在的代码可以改成这样的</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804150953.png\"></p>\n<p>这句代码实际上是对后面使用这个对象调用方法的时候产生影响的，具体影响在上文解释差不多了。</p>\n<p>再次运行看看</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804151901.png\"></p>\n<p>已经解决了，下面发现又有AbstractJni方法缺失了，需要去补了</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804152126.png\"></p>\n<p>从这copy一手，嘿嘿，省事</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804152513.png\"></p>\n<p>再次运行</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804152539.png\"></p>\n<p>好家伙，返回1234，居然还没被骗，我们需要根据参数去判断，或者frida hook会返回值</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804153000.png\"></p>\n<p>android_id是可以返回空的，为了防止出问题，还是返回空</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804153354.png\"></p>\n<p>继续补了一手，基本上已经没有报错了，下面就开始正式执行了，unidbg补环境才是真的恶心。。</p>\n<p>继续组装一手jni的参数</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">public void  getInfo2()\n    &#123;\n        List&lt;Object&gt; list&#x3D;new ArrayList&lt;&gt;(10);\n        list.add(vm.getJNIEnv());\n        list.add(0);\n        Object custom&#x3D;null;\n        DvmObject&lt;?&gt; context&#x3D;vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;).newObject(custom);\n        list.add(vm.addLocalObject(context));\n        list.add(0x17AD420321AL);\n\n        Number number&#x3D;module.callFunction(emulator,0xe3d5,list.toArray())[0];\n        String result&#x3D;vm.getObject(number.intValue()).getValue().toString();\n        System.out.println(&quot;result:&quot;+result);\n    &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>继续运行，发现还需要补环境</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804170534.png\"></p>\n<p>这里需要用到一个神器，jnitrace，我们可以根据jnitrace的日志进行补环境，嘿嘿</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804170619.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804170835.png\"></p>\n<p>根据这个来补环境，返回值补成0,</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">@Override\n public int callIntMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n     switch (signature)\n     &#123;\n         case &quot;android&#x2F;content&#x2F;Context-&gt;checkSelfPermission(Ljava&#x2F;lang&#x2F;String;)I&quot;:\n             return 0;\n     &#125;\n     return super.callIntMethod(vm, dvmObject, signature, varArg);\n &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804171053.png\"></p>\n<p>继续看下一个</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804171305.png\"></p>\n<p>这里输入是jstring，返回值是jobject，但是这里的十六进制，实际上只是引用，而且由于多线程的原因，还有可能是错误的，所以慎重。</p>\n<p>这里还是选择google大法，去查这个函数究竟返回了啥</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804171915.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804172221.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804172257.png\"></p>\n<p>原来是返回一个TelephonyManager对象，安排</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">public DvmObject&lt;?&gt; callObjectMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n     switch (signature)\n     &#123;\n         case &quot;android&#x2F;content&#x2F;Context-&gt;getSystemService(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;Object;&quot;:\n\n             return vm.resolveClass(&quot;android&#x2F;telephony&#x2F;TelephonyManager&quot;).newObject(signature);\n\n\n     &#125;\n     return super.callObjectMethod(vm, dvmObject, signature, varArg);\n &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但是又报错了，再次jnitrace打开，发现返回时局部引用，0xxx，不过不用担心我们可以从log中找到这个局部引用的值，比如newstringutf，getstringutf等函数，</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804173244.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804173300.png\"></p>\n<p>继续下一个报错</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804173504.png\"></p>\n<p>在不断的补全中，</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">package pdd;\nimport com.github.unidbg.AndroidEmulator;\nimport com.github.unidbg.Module;\nimport com.github.unidbg.linux.android.AndroidEmulatorBuilder;\nimport com.github.unidbg.linux.android.AndroidResolver;\nimport com.github.unidbg.linux.android.dvm.*;\nimport com.github.unidbg.memory.Memory;\nimport com.shuzilm.OnSSChanged;\nimport com.sun.xml.internal.rngom.parse.host.Base;\nimport org.apache.log4j.Level;\nimport org.apache.log4j.Logger;\n\nimport java.io.File;\nimport java.util.ArrayList;\nimport java.util.List;\n\npublic class Pdds extends AbstractJni&#123;\n    private final AndroidEmulator emulator;\n    private final VM vm;\n    private final Module module;\n    public Pdds()\n    &#123;\n        emulator&#x3D; AndroidEmulatorBuilder.for32Bit().build();\n        &#x2F;&#x2F;2. 绑定IO重定向接口\n        &#x2F;&#x2F;emulator.getSyscallHandler().addIOResolver(this);\n        System.out.println(&quot;当前进程pid:&quot;+emulator.getPid());\n        final Memory memory&#x3D; emulator.getMemory();\n        memory.setLibraryResolver(new AndroidResolver(23));\n\n        vm&#x3D;emulator.createDalvikVM(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;120_2b38cee52e87d55c632643a9d8b7d52b.apk&quot;));\n        vm.setVerbose(true); &#x2F;&#x2F;打印jni调用细节\n        vm.setJni(this); &#x2F;&#x2F;设置jni接口\n\n\n        &#x2F;&#x2F;new AndroidModule(emulator,vm).register(memory);\n        DalvikModule dm_libc_shared&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libc++_shared.so&quot;),true);\n        dm_libc_shared.callJNI_OnLoad(emulator);\n        DalvikModule dm_libUserEnv&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libUserEnv.so&quot;),true);\n        dm_libUserEnv.callJNI_OnLoad(emulator);\n        DalvikModule dm&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libpdd_secure.so&quot;),true);\n        module&#x3D;dm.getModule();\n\n        dm.callJNI_OnLoad(emulator);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;\n        switch (signature)&#123;\n            case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;ANDROID_ID:Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;android_id&quot;);\n        &#125;\n        return super.getStaticObjectField(vm, dvmClass, signature);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;\n        switch (signature)&#123;\n            &#x2F;*case &quot;android&#x2F;app&#x2F;ActivityThread-&gt;getApplication()Landroid&#x2F;app&#x2F;Application;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;ContextWrapper&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;))).newObject(signature);\n             *&#x2F;\n             case &quot;android&#x2F;app&#x2F;ActivityThread-&gt;getApplication()Landroid&#x2F;app&#x2F;Application;&quot;:\n                 DvmClass application&#x3D;vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;));\n                 return application.newObject(null);\n\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getContentResolver()Landroid&#x2F;content&#x2F;ContentResolver;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;content&#x2F;ContentResolver&quot;).newObject(signature);\n\n\n        &#125;\n        return super.callObjectMethodV(vm, dvmObject, signature, vaList);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;\n        switch (signature) &#123;\n        case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;getString(Landroid&#x2F;content&#x2F;ContentResolver;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;:\n\n            return new StringObject(vm,&quot;&quot;);\n\n    &#125;\n        return super.callStaticObjectMethodV(vm, dvmClass, signature, vaList);\n    &#125;\n\n    @Override\n    public void callStaticVoidMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;\n        switch (signature)\n        &#123;\n            case &quot;com&#x2F;tencent&#x2F;mars&#x2F;xlog&#x2F;PLog-&gt;i(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)V&quot;:\n                return;\n\n        &#125;\n        super.callStaticVoidMethodV(vm, dvmClass, signature, vaList);\n    &#125;\n\n    @Override\n    public int callIntMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;content&#x2F;Context-&gt;checkSelfPermission(Ljava&#x2F;lang&#x2F;String;)I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getPhoneType()I&quot;:\n                return 1;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimState()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkType()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDataState()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDataActivity()I&quot;:\n                return 0;\n        &#125;\n        return super.callIntMethod(vm, dvmObject, signature, varArg);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callObjectMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getSystemService(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;Object;&quot;:\n\n                return vm.resolveClass(&quot;android&#x2F;telephony&#x2F;TelephonyManager&quot;).newObject(signature);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDeviceId()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;352531085901013&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDeviceId(I)Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;352531085901013&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimSerialNumber()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimOperatorName()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimCountryIso()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSubscriberId()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkOperator()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkOperatorName()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkCountryIso()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getContentResolver()Landroid&#x2F;content&#x2F;ContentResolver;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;content&#x2F;ContentResolver&quot;).newObject(signature);\n\n        &#125;\n        return super.callObjectMethod(vm, dvmObject, signature, varArg);\n    &#125;\n\n    @Override\n    public int getStaticIntField(BaseVM vm, DvmClass dvmClass, String signature) &#123;\n\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;PHONE_TYPE_GSM:I&quot;:\n                return 1;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;PHONE_TYPE_CDMA:I&quot;:\n                return 1;\n\n        &#125;\n        return super.getStaticIntField(vm, dvmClass, signature);\n    &#125;\n\n    public void  getInfo2()\n    &#123;\n        List&lt;Object&gt; list&#x3D;new ArrayList&lt;&gt;(10);\n        list.add(vm.getJNIEnv());\n        list.add(0);\n        Object custom&#x3D;null;\n        DvmObject&lt;?&gt; context&#x3D;vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;).newObject(custom);\n        list.add(vm.addLocalObject(context));\n        list.add(0x17AD420321AL);\n\n        Number number&#x3D;module.callFunction(emulator,0xe3d5,list.toArray())[0];\n        String result&#x3D;vm.getObject(number.intValue()).getValue().toString();\n        System.out.println(&quot;result:&quot;+result);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callStaticObjectMethod(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;getString(Landroid&#x2F;content&#x2F;ContentResolver;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;:\n                if (varArg.getObjectArg(1).getValue().toString().equals(&quot;android_id&quot;))\n                &#123;\n                    return new StringObject(vm,&quot;&quot;);\n                &#125;\n        &#125;\n        return super.callStaticObjectMethod(vm, dvmClass, signature, varArg);\n    &#125;\n\n    @Override\n    public boolean callStaticBooleanMethod(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;os&#x2F;Debug-&gt;isDebuggerConnected()Z&quot;:\n                return false;\n        &#125;\n        return super.callStaticBooleanMethod(vm, dvmClass, signature, varArg);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; newObject(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;java&#x2F;lang&#x2F;Throwable-&gt;&lt;init&gt;()V&quot;:\n                return vm.resolveClass(&quot;java&#x2F;lang&#x2F;Throwable&quot;).newObject(new Throwable());\n        &#125;\n        return super.newObject(vm, dvmClass, signature, varArg);\n    &#125;\n\n    public static void main(String[] args) &#123;\n        Logger.getLogger(DalvikVM.class).setLevel(Level.DEBUG);\n        Logger.getLogger(BaseVM.class).setLevel(Level.DEBUG);\n\n        Pdds ss&#x3D;new Pdds();\n        ss.getInfo2();\n    &#125;\n&#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>来到一个堆栈的地方了，这里有点像检查xposed的hook，打印堆栈，如果有xposed的模块会有痕迹的</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804183307.png\"></p>\n<p>jnitrace跟一手这个函数</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804183436.png\"></p>\n<p>我这么补一手,frida脚本</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> \n\n\n\n\nfunction main()\n&#123;\n    Java.perform(function()&#123;\n       &#x2F;&#x2F; cn.shuzilm.core.DUHelper.query(android.content.Context, java.lang.String, java.lang.String) : java.lang.String\n      &#x2F;* Java.use(&quot;cn.shuzilm.core.Main&quot;).query.implementation&#x3D;function(arg1,arg2,arg3)\n       &#123;\n           console.log(&quot;arg1:&quot;,arg1);\n           console.log(&quot;arg2:&quot;,arg2);\n           console.log(&quot;arg3:&quot;,arg3);\n           var ret&#x3D;this.query(arg1,arg2,arg3);\n           console.log(&quot;ret:&quot;,ret);\n           return ret;\n       &#125;\n       *&#x2F;\n       &#x2F;&#x2F;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDeviceId()Ljava&#x2F;lang&#x2F;String\n       &#x2F;&#x2F;java&#x2F;lang&#x2F;Throwable-&gt;getStackTrace()[Ljava&#x2F;lang&#x2F;StackTraceElement\n       Java.use(&quot;java.lang.Throwable&quot;).getStackTrace.implementation&#x3D;function()&#123;\n           var ret&#x3D;this.getStackTrace();\n           if(ret[0].toString().indexOf(&quot;DeviceNative.info2&quot;)!&#x3D;-1)\n           &#123;\n            for(var i&#x3D;0;i&lt;ret.length;i++)\n            &#123;\n             console.log(ret[i]);\n            &#125;\n           &#125;\n           \n          \n           return ret;\n       &#125;\n\n    &#125;)\n&#125;\nsetImmediate(main);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804205453.png\"></p>\n<p>学习了，先new class，最后再用一个new  ArrayObject</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804205815.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210804205830.png\"></p>\n<p>这补一手，主要因为是本身那个对象就有getClassName方法，我们可以直接嫖它的2333</p>\n<p>剩下补环境的代码，好家伙，完整搞下来学了很多，花了很多时间了，感谢龙哥</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">package pdd;\nimport com.github.unidbg.AndroidEmulator;\nimport com.github.unidbg.Module;\nimport com.github.unidbg.linux.android.AndroidEmulatorBuilder;\nimport com.github.unidbg.linux.android.AndroidResolver;\nimport com.github.unidbg.linux.android.dvm.*;\nimport com.github.unidbg.linux.android.dvm.array.ArrayObject;\nimport com.github.unidbg.linux.android.dvm.array.ByteArray;\nimport com.github.unidbg.memory.Memory;\nimport com.shuzilm.OnSSChanged;\nimport com.sun.xml.internal.rngom.parse.host.Base;\nimport org.apache.log4j.Level;\nimport org.apache.log4j.Logger;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.File;\nimport java.io.OutputStream;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.UUID;\nimport java.util.zip.GZIPOutputStream;\n\npublic class Pdds extends AbstractJni&#123;\n    private final AndroidEmulator emulator;\n    private final VM vm;\n    private final Module module;\n    public Pdds()\n    &#123;\n        emulator&#x3D; AndroidEmulatorBuilder.for32Bit().build();\n        &#x2F;&#x2F;2. 绑定IO重定向接口\n        &#x2F;&#x2F;emulator.getSyscallHandler().addIOResolver(this);\n        System.out.println(&quot;当前进程pid:&quot;+emulator.getPid());\n        final Memory memory&#x3D; emulator.getMemory();\n        memory.setLibraryResolver(new AndroidResolver(23));\n\n        vm&#x3D;emulator.createDalvikVM(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;120_2b38cee52e87d55c632643a9d8b7d52b.apk&quot;));\n        vm.setVerbose(true); &#x2F;&#x2F;打印jni调用细节\n        vm.setJni(this); &#x2F;&#x2F;设置jni接口\n\n\n        &#x2F;&#x2F;new AndroidModule(emulator,vm).register(memory);\n        DalvikModule dm_libc_shared&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libc++_shared.so&quot;),true);\n        dm_libc_shared.callJNI_OnLoad(emulator);\n        DalvikModule dm_libUserEnv&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libUserEnv.so&quot;),true);\n        dm_libUserEnv.callJNI_OnLoad(emulator);\n        DalvikModule dm&#x3D;vm.loadLibrary(new File(&quot;unidbg-android&#x2F;src&#x2F;main&#x2F;java&#x2F;pdd&#x2F;libpdd_secure.so&quot;),true);\n        module&#x3D;dm.getModule();\n\n        dm.callJNI_OnLoad(emulator);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;\n        switch (signature)&#123;\n            case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;ANDROID_ID:Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;android_id&quot;);\n        &#125;\n        return super.getStaticObjectField(vm, dvmClass, signature);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;\n        switch (signature)&#123;\n            &#x2F;*case &quot;android&#x2F;app&#x2F;ActivityThread-&gt;getApplication()Landroid&#x2F;app&#x2F;Application;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;ContextWrapper&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;))).newObject(signature);\n             *&#x2F;\n             case &quot;android&#x2F;app&#x2F;ActivityThread-&gt;getApplication()Landroid&#x2F;app&#x2F;Application;&quot;:\n                 DvmClass application&#x3D;vm.resolveClass(&quot;android&#x2F;app&#x2F;Application&quot;, vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;));\n                 return application.newObject(null);\n\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getContentResolver()Landroid&#x2F;content&#x2F;ContentResolver;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;content&#x2F;ContentResolver&quot;).newObject(signature);\n            case &quot;java&#x2F;util&#x2F;UUID-&gt;toString()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,dvmObject.getValue().toString());\n\n        &#125;\n        return super.callObjectMethodV(vm, dvmObject, signature, vaList);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;\n        switch (signature) &#123;\n        case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;getString(Landroid&#x2F;content&#x2F;ContentResolver;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;:\n\n            return new StringObject(vm,&quot;&quot;);\n\n    &#125;\n        return super.callStaticObjectMethodV(vm, dvmClass, signature, vaList);\n    &#125;\n\n    @Override\n    public void callStaticVoidMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;\n        switch (signature)\n        &#123;\n            case &quot;com&#x2F;tencent&#x2F;mars&#x2F;xlog&#x2F;PLog-&gt;i(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)V&quot;:\n                return;\n\n        &#125;\n        super.callStaticVoidMethodV(vm, dvmClass, signature, vaList);\n    &#125;\n\n    @Override\n    public int callIntMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;content&#x2F;Context-&gt;checkSelfPermission(Ljava&#x2F;lang&#x2F;String;)I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getPhoneType()I&quot;:\n                return 1;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimState()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkType()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDataState()I&quot;:\n                return 0;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDataActivity()I&quot;:\n                return 0;\n        &#125;\n        return super.callIntMethod(vm, dvmObject, signature, varArg);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callObjectMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getSystemService(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;Object;&quot;:\n\n                return vm.resolveClass(&quot;android&#x2F;telephony&#x2F;TelephonyManager&quot;).newObject(signature);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDeviceId()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;352531085901013&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getDeviceId(I)Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;352531085901013&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimSerialNumber()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimOperatorName()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSimCountryIso()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getSubscriberId()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkOperator()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkOperatorName()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;getNetworkCountryIso()Ljava&#x2F;lang&#x2F;String;&quot;:\n                return new StringObject(vm,&quot;&quot;);\n            case &quot;android&#x2F;content&#x2F;Context-&gt;getContentResolver()Landroid&#x2F;content&#x2F;ContentResolver;&quot;:\n                return vm.resolveClass(&quot;android&#x2F;content&#x2F;ContentResolver&quot;).newObject(signature);\n            case &quot;java&#x2F;lang&#x2F;Throwable-&gt;getStackTrace()[Ljava&#x2F;lang&#x2F;StackTraceElement;&quot;:\n                StackTraceElement[] elements&#x3D;&#123;\n                        new StackTraceElement(&quot;com.xunmeng.pinduoduo.secure.DeviceNative&quot;,&quot;info2&quot;,&quot;&quot;,0),\n                new StackTraceElement(&quot;com.xunmeng.pinduoduo.secure.SecureNative.&quot;,&quot;deviceInfo2&quot;,&quot;&quot;,0),\n                new StackTraceElement(&quot;com.xunmeng.pinduoduo.secure.q&quot;,&quot;d&quot;,&quot;&quot;,0)\n                &#125;;\n                DvmObject[] dvmObjects&#x3D;new DvmObject[elements.length];\n                for(int i&#x3D;0;i&lt;elements.length;i++)\n                &#123;\n                    dvmObjects[i]&#x3D;vm.resolveClass(&quot;java&#x2F;lang&#x2F;StackTraceElement&quot;).newObject(dvmObjects[i]);\n                &#125;\n                return new ArrayObject(dvmObjects);\n            case &quot;java&#x2F;lang&#x2F;StackTraceElement-&gt;getClassName()Ljava&#x2F;lang&#x2F;String;&quot;:\n                StackTraceElement element&#x3D;(StackTraceElement)dvmObject.getValue();\n                return new StringObject(vm,element.getClassName());\n            case &quot;java&#x2F;util&#x2F;UUID-&gt;randomUUID()Ljava&#x2F;util&#x2F;UUID;&quot;:\n                return vm.resolveClass(&quot;java&#x2F;util&#x2F;UUID&quot;).newObject(UUID.randomUUID());\n            case &quot;java&#x2F;lang&#x2F;String-&gt;replaceAll(Ljava&#x2F;lang&#x2F;String;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;:\n                StringObject str&#x3D;(StringObject) dvmObject;\n                StringObject s1&#x3D;varArg.getObjectArg(0);\n                StringObject s2&#x3D;varArg.getObjectArg(1);\n                assert s1!&#x3D;null;\n                assert s2!&#x3D;null;\n                return new StringObject(vm,str.getValue().replaceAll(s1.getValue(),s2.getValue()));\n            case &quot;java&#x2F;io&#x2F;ByteArrayOutputStream-&gt;toByteArray()[B&quot;:\n                ByteArrayOutputStream byteArrayOutputStream&#x3D;(ByteArrayOutputStream) dvmObject.getValue();\n                byte[] result&#x3D;byteArrayOutputStream.toByteArray();\n                return new ByteArray(vm,result);\n\n\n\n        &#125;\n        return super.callObjectMethod(vm, dvmObject, signature, varArg);\n    &#125;\n\n    @Override\n    public int getStaticIntField(BaseVM vm, DvmClass dvmClass, String signature) &#123;\n\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;PHONE_TYPE_GSM:I&quot;:\n                return 1;\n            case &quot;android&#x2F;telephony&#x2F;TelephonyManager-&gt;PHONE_TYPE_CDMA:I&quot;:\n                return 1;\n\n        &#125;\n        return super.getStaticIntField(vm, dvmClass, signature);\n    &#125;\n\n    public void  getInfo2()\n    &#123;\n        List&lt;Object&gt; list&#x3D;new ArrayList&lt;&gt;(10);\n        list.add(vm.getJNIEnv());\n        list.add(0);\n        Object custom&#x3D;null;\n        DvmObject&lt;?&gt; context&#x3D;vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;).newObject(custom);\n        list.add(vm.addLocalObject(context));\n        list.add(0x17AD420321AL);\n\n        Number number&#x3D;module.callFunction(emulator,0xe3d5,list.toArray())[0];\n        String result&#x3D;vm.getObject(number.intValue()).getValue().toString();\n        System.out.println(&quot;result:&quot;+result);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; callStaticObjectMethod(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;provider&#x2F;Settings$Secure-&gt;getString(Landroid&#x2F;content&#x2F;ContentResolver;Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;&quot;:\n                if (varArg.getObjectArg(1).getValue().toString().equals(&quot;android_id&quot;))\n                &#123;\n                    return new StringObject(vm,&quot;&quot;);\n                &#125;\n        &#125;\n        return super.callStaticObjectMethod(vm, dvmClass, signature, varArg);\n    &#125;\n\n    @Override\n    public boolean callStaticBooleanMethod(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;android&#x2F;os&#x2F;Debug-&gt;isDebuggerConnected()Z&quot;:\n                return false;\n        &#125;\n        return super.callStaticBooleanMethod(vm, dvmClass, signature, varArg);\n    &#125;\n\n    @Override\n    public DvmObject&lt;?&gt; newObject(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;java&#x2F;lang&#x2F;Throwable-&gt;&lt;init&gt;()V&quot;:\n                return vm.resolveClass(&quot;java&#x2F;lang&#x2F;Throwable&quot;).newObject(new Throwable());\n            case &quot;java&#x2F;io&#x2F;ByteArrayOutputStream-&gt;&lt;init&gt;()V&quot;:\n                return vm.resolveClass(&quot;java&#x2F;io&#x2F;ByteArrayOutputStream&quot;).newObject(new ByteArrayOutputStream());\n            &#x2F;&#x2F;或者 return dvmclass.newObject(new ByteArrayOutputStream())\n            case &quot;java&#x2F;util&#x2F;zip&#x2F;GZIPoutputStream-&gt;&lt;init&gt;(Ljava&#x2F;io&#x2F;OutputStream;)V&quot;:\n                OutputStream outputStream&#x3D;(OutputStream) varArg.getObjectArg(0).getValue();\n                try&#123;\n                    return dvmClass.newObject(new GZIPOutputStream(outputStream));\n                &#125;catch (Exception e)\n                &#123;\n                    e.printStackTrace();\n                &#125;\n        &#125;\n        return super.newObject(vm, dvmClass, signature, varArg);\n    &#125;\n\n    @Override\n    public void callVoidMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) &#123;\n        switch (signature)\n        &#123;\n            case &quot;java&#x2F;util&#x2F;zip&#x2F;GZIPoutputStream-&gt;write([B)V&quot;:\n                GZIPOutputStream gzipOutputStream&#x3D;(GZIPOutputStream) dvmObject.getValue();\n                byte[] input&#x3D;(byte[])varArg.getObjectArg(0).getValue();\n                try&#123;\n                    gzipOutputStream.write(input);\n                &#125;catch (Exception e)\n                &#123;\n                    e.printStackTrace();\n                &#125;\n            case &quot;java&#x2F;util&#x2F;zip&#x2F;GZIPouputStream-&gt;finish()V&quot;:\n                GZIPOutputStream gzipOutputStream1&#x3D;(GZIPOutputStream) dvmObject.getValue();\n                try&#123;\n                    gzipOutputStream1.finish();\n                &#125;catch (Exception e)\n                &#123;\n                    e.printStackTrace();\n                &#125;; \n                \n            case &quot;java&#x2F;util&#x2F;zip&#x2F;GZIPOutputStream-&gt;close()V&quot;:\n                GZIPOutputStream gzipOutputStream2&#x3D;(GZIPOutputStream) dvmObject.getValue();\n                try&#123;\n                    gzipOutputStream2.close();\n                &#125;catch (Exception e)\n                &#123;\n                    e.printStackTrace();;\n                &#125;\n                        \n                         \n        &#125;\n        super.callVoidMethod(vm, dvmObject, signature, varArg);\n    &#125;\n\n    public static void main(String[] args) &#123;\n        Logger.getLogger(DalvikVM.class).setLevel(Level.DEBUG);\n        Logger.getLogger(BaseVM.class).setLevel(Level.DEBUG);\n\n        Pdds ss&#x3D;new Pdds();\n        ss.getInfo2();\n    &#125;\n&#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","feature":null,"text":"目标锁定 开始编写unidbg代码看看会报什么错package pdd; import com.github.unidbg.AndroidEmulator; import com.github.unidbg.Module; import com.github.unidbg.lin...","link":"","photos":[],"count_time":{"symbolsCount":"39k","symbolsTime":"36 mins."},"categories":[{"name":"unidbg","slug":"unidbg","count":3,"path":"api/categories/unidbg.json"}],"tags":[{"name":"reverse","slug":"reverse","count":20,"path":"api/tags/reverse.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E6%A0%87%E9%94%81%E5%AE%9A\"><span class=\"toc-text\">目标锁定</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BC%80%E5%A7%8B%E7%BC%96%E5%86%99unidbg%E4%BB%A3%E7%A0%81%E7%9C%8B%E7%9C%8B%E4%BC%9A%E6%8A%A5%E4%BB%80%E4%B9%88%E9%94%99\"><span class=\"toc-text\">开始编写unidbg代码看看会报什么错</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%BC%BA%E5%B0%91libUserEnv-so\"><span class=\"toc-text\">缺少libUserEnv.so</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""},"mapped":true,"prev_post":{},"next_post":{"title":"unicorn自动化解决迷宫问题","uid":"6946deb52774246dc7e3f9d367660594","slug":"unicorn自动化解决迷宫问题","date":"2021-08-02T04:11:18.000Z","updated":"2021-08-02T12:37:55.592Z","comments":true,"path":"api/articles/unicorn自动化解决迷宫问题.json","keywords":null,"cover":"https://w.wallhaven.cc/full/r2/wallhaven-r2e9kq.jpg","text":"unicorn简单使用unicorn是一个跨平台的模拟执行框架，在我最近使用看来，是具有对内存和指令有着完全操纵权的框架，具有很高的可定制化，是一种天然的沙盒 from unicorn import * from unicorn.arm_const import * ARM_CO...","link":"","photos":[],"count_time":{"symbolsCount":"5.5k","symbolsTime":"5 mins."},"categories":[{"name":"unicorn","slug":"unicorn","count":1,"path":"api/categories/unicorn.json"}],"tags":[{"name":"reverse","slug":"reverse","count":20,"path":"api/tags/reverse.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}}}