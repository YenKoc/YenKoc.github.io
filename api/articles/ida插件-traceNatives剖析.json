{"title":"ida插件_traceNatives剖析","uid":"da27febfe9a3ffe7e8fc2063f78d23df","slug":"ida插件-traceNatives剖析","date":"2021-03-29T13:01:59.000Z","updated":"2021-03-29T15:56:34.374Z","comments":true,"path":"api/articles/ida插件-traceNatives剖析.json","keywords":null,"cover":[],"content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>前几天在肉丝朋友圈看到了龙哥的新作，一个名叫trace_native的ida插件项目，我出于好奇就想看看源码，发现好想原理也不难，不过提升了效率，还是很不错的</p>\n<h1 id=\"源码剖析\"><a href=\"#源码剖析\" class=\"headerlink\" title=\"源码剖析\"></a>源码剖析</h1><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">from</span> idaapi <span class=\"token keyword\">import</span> plugin_t\n<span class=\"token keyword\">from</span> idaapi <span class=\"token keyword\">import</span> PLUGIN_PROC\n<span class=\"token keyword\">from</span> idaapi <span class=\"token keyword\">import</span> PLGIN_OK\n<span class=\"token keyword\">import</span> ida_nalt\n<span class=\"token keyword\">import</span> idaapi\n<span class=\"token keyword\">import</span> idautils\n<span class=\"token keyword\">import</span> idc\n<span class=\"token keyword\">import</span> time\n\n<span class=\"token comment\"># 获取so文件名和路径</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">getSoPathAndName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n  fullpath<span class=\"token operator\">=</span>ida_nalt<span class=\"token punctuation\">.</span>get_input_file_path<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">#从完整路径中取出，文件路径和文件名</span>\n  filepath<span class=\"token punctuation\">,</span>filename<span class=\"token operator\">=</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>fullpath<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> filepath<span class=\"token punctuation\">,</span>filename\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\"># 获取代码段的起始地址和结束地址</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">getSegAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n  finalStart<span class=\"token operator\">=</span><span class=\"token number\">0xffffffff</span>\n  finalEnd<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n  <span class=\"token keyword\">for</span> seg <span class=\"token keyword\">in</span> idautils<span class=\"token punctuation\">.</span>Segments<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  \t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>idc<span class=\"token punctuation\">.</span>get_segm_name<span class=\"token punctuation\">(</span>seg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token string\">'.text'</span> <span class=\"token keyword\">or</span> <span class=\"token punctuation\">(</span>idc<span class=\"token punctuation\">.</span>get_segm_name<span class=\"token punctuation\">(</span>seg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">:</span>\n  \t\ttempStart<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_segm_start<span class=\"token punctuation\">(</span>seg<span class=\"token punctuation\">)</span>\n  \t\ttempEnd<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_segm_end<span class=\"token punctuation\">(</span>seg<span class=\"token punctuation\">)</span>\n  \t\t<span class=\"token keyword\">if</span> finalStart<span class=\"token operator\">></span>tempStart<span class=\"token punctuation\">:</span>\n  \t\t\t\tfinalStart<span class=\"token operator\">=</span>tempStart\n  \t\t<span class=\"token keyword\">if</span> finalEnd<span class=\"token operator\">&lt;</span>tempEnd<span class=\"token punctuation\">:</span>\n  \t\t\t\tfinalEnd<span class=\"token operator\">=</span>tempEnd\n\t<span class=\"token keyword\">return</span> finalStart<span class=\"token punctuation\">,</span>textEnd\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">traceNatives</span><span class=\"token punctuation\">(</span>plugin_t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  flags<span class=\"token operator\">=</span>PLUGIN_PROC\n  comment<span class=\"token operator\">=</span><span class=\"token string\">\"traceNatives\"</span>\n  <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\n  wanted_name<span class=\"token operator\">=</span><span class=\"token string\">\"traceNatives\"</span>\n  wanted_hotkey<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\n  \n  <span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"traceNatives(v0.1) plugin has been loaded\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> PLUGIN_OK\n  <span class=\"token keyword\">def</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    ea<span class=\"token punctuation\">,</span>ed<span class=\"token operator\">=</span>getSegAddr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    search_result<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> func <span class=\"token keyword\">in</span> idautils<span class=\"token punctuation\">.</span>Functions<span class=\"token punctuation\">(</span>ea<span class=\"token punctuation\">,</span>ed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        functionName<span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>idaapi<span class=\"token punctuation\">.</span>ida_funcs<span class=\"token punctuation\">.</span>get_func_name<span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>idautils<span class=\"token punctuation\">.</span>FuncItems<span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">10</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\">#如果是thumb模式，地址+1</span>\n          arm_or_thumb<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_sreg<span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">,</span><span class=\"token string\">\"T\"</span><span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span> arm_or_thumb<span class=\"token punctuation\">:</span>\n            func<span class=\"token operator\">+=</span><span class=\"token number\">1</span>\n          search_result<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span>\n    \n    so_path<span class=\"token punctuation\">,</span>so_name<span class=\"token operator\">=</span>getSoPathAndName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    search_result<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"-a '</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>so_name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">!</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>offset<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">'\"</span></span> <span class=\"token keyword\">for</span> offset <span class=\"token keyword\">in</span> search_result<span class=\"token punctuation\">]</span>\n    search_result<span class=\"token operator\">=</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>search_result<span class=\"token punctuation\">)</span>\n    \n    script_name<span class=\"token operator\">=</span>so_name<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token string\">\"_\"</span><span class=\"token operator\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\".txt\"</span>\n    save_path<span class=\"token operator\">=</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>so_path<span class=\"token punctuation\">,</span>script_name<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>save_path<span class=\"token punctuation\">,</span><span class=\"token string\">\"w\"</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n      f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>search_result<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"使用方法如下:\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"frida-trace -UF -O </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>save_path<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">term</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span>\n \t\n<span class=\"token keyword\">def</span> <span class=\"token function\">PLUGIN_ENTRY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">return</span> traceNatives<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     \n         <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>实际上，就是通过idapython提供的api，先找出代码段的起始地址和结尾地址，然后对代码段中的函数进行遍历，判断是thumb模式还是arm模式，然后根据什么模式，对地址进行处理，搞完之后，将地址存入一个列表中，之后就进行字符串拼接，为后续使用frida-trace批量hook，作准备，我改了一个地方，感觉那个地方写的有点浪费内存。</p>\n<h1 id=\"效果演示\"><a href=\"#效果演示\" class=\"headerlink\" title=\"效果演示\"></a>效果演示</h1><p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210329224124.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210329235006.png\"></p>\n","feature":null,"text":"前言前几天在肉丝朋友圈看到了龙哥的新作，一个名叫trace_native的ida插件项目，我出于好奇就想看看源码，发现好想原理也不难，不过提升了效率，还是很不错的 源码剖析import os from idaapi import plugin_t from idaapi impo...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"ida插件","slug":"ida插件","count":1,"path":"api/tags/ida插件.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90\"><span class=\"toc-text\">源码剖析</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%95%88%E6%9E%9C%E6%BC%94%E7%A4%BA\"><span class=\"toc-text\">效果演示</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":""},"mapped":true,"prev_post":{},"next_post":{"title":"apkleaks的安装与使用","uid":"6c1a2f5fee044dc2bb2b3084d9a71810","slug":"apkleaks的安装与使用","date":"2021-03-26T18:23:40.000Z","updated":"2021-03-26T18:32:27.323Z","comments":true,"path":"api/articles/apkleaks的安装与使用.json","keywords":null,"cover":[],"text":"前言上次开会的时候，听小帅有个可以从app中找接口的一个github项目，最近一直忙资产收集，所以没空看，今晚刚好有空，就clone了一份，并安装了，我习惯用kali了，所以这里安装也是以kali作为主力 安装方法 clone一份到本地 进入目录后，输入pip3 install ...","link":"","photos":[],"count_time":{"symbolsCount":453,"symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"android工具使用","slug":"android工具使用","count":1,"path":"api/tags/android工具使用.json"}],"author":{"name":"YenKoc","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":""}}}