{"title":"看雪某数字壳测试题","uid":"509e3543271104a33a26b59536e47f22","slug":"看雪某数字壳测试题","date":"2021-04-07T01:48:58.000Z","updated":"2021-04-19T13:32:42.714Z","comments":true,"path":"api/articles/看雪某数字壳测试题.json","keywords":null,"cover":"https://w.wallhaven.cc/full/x8/wallhaven-x88o53.jpg","content":"<h1 id=\"脱壳\"><a href=\"#脱壳\" class=\"headerlink\" title=\"脱壳\"></a>脱壳</h1><p>发现加了数字壳，直接用frida-的dexdump或者寒冰大佬的fart脱，就完事了，我这里还是比较喜欢objection搭配frida-dexdump插件的方式，比较方便，对这种没抽取的壳，也完全足够了，直接操作</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407095234.png\"></p>\n<p>从内存中dump下了，三个dex，命令行输入grep -ril “MainActivity” * ，把主活动找到，发现是d0开头的dex</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407095438.png\"></p>\n<h1 id=\"代码分析\"><a href=\"#代码分析\" class=\"headerlink\" title=\"代码分析\"></a>代码分析</h1><p>将脱下来的dex，拖入jadx中，发现效果并不好，很多地方找不到，这也是为什么寒冰喜欢用gda来反编译吧，国产牛逼！</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407095712.png\"></p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407095741.png\"></p>\n<p>不过发现一个问题，就是所有的方法，都变成native函数了，这不就是dex2c吗，好家伙，直接ida安排上，去找这个onclick方法</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407095903.png\"></p>\n<p>发现这个onclick方法中字符串全被加密了，同时加密的函数就在.init段，可以看到一段的代码进行异或</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/image-20210407100028675.png\" alt=\"image-20210407100028675\"></p>\n<p>好家伙，这里有两个选择，要么静态的去写ida脚本，要么就是动态直接attach上去，毕竟这个段是在so载入内存中就会执行的，所以我们只要attach上去的话，字符串就是解密后的</p>\n<p>这里我没截图了，昨晚写的了，稍微描述下过程，开启androidserver，端口转发后，直接开始attach，attach上去后，不需要操作了，毕竟我们没在哪个so中下断点，我们只要在内存中找到我们想要的函数，根据so的基地址加上函数偏移，所以根本别慌，这里有个坑点就是搜出来有两个so文件，具体选哪个，得看，我们加上偏移后是否跳转到正确地址上。</p>\n<p>找到正确函数了，f5，然后改jnienv之后，发现就是典型的dex2c，在jni层调用java层的函数，沉思，我就在想那么直接hook，所有的getxxxxid，setxxxid不就完事，找了杨神之前的脚本，直接hook发现，奔溃了。。估计有反frida。。这里有个思想我觉得很好，就是从底层考虑起来，有时候直接去找哪里反调试，压力很大，逆向的去想，既然反调试奔溃了，那必然调用了一个奔溃函数，那么我们是不是可以通过找到奔溃函数的引用，一步一步的反跟上去呢。</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407101023.png\"></p>\n<p>在两个so中，都搜了下，发现在libnative-lib.so下还真有，找到了反调试的地方</p>\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/image-20210407101131715.png\" alt=\"image-20210407101131715\"></p>\n<p>那么我们第一步就需要把反调试给绕过了，这里是选择hook kill函数，毕竟kill是退出，如果hook为空，程序不就正常了。</p>\n<p>其实还有很多操作，比如hook strstr，getpid（）都是可以的</p>\n<p>直接上脚本</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n\n&#x2F;*\nGetFieldID is at  0xe39b87c5 _ZN3art3JNI10GetFieldIDEP7_JNIEnvP7_jclassPKcS6_\nGetMethodID is at  0xe39a1a19 _ZN3art3JNI11GetMethodIDEP7_JNIEnvP7_jclassPKcS6_\nNewStringUTF is at  0xe39cff25 _ZN3art3JNI12NewStringUTFEP7_JNIEnvPKc\nRegisterNatives is at  0xe39e08fd _ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi\nGetStaticFieldID is at  0xe39c9635 _ZN3art3JNI16GetStaticFieldIDEP7_JNIEnvP7_jclassPKcS6_\nGetStaticMethodID is at  0xe39be0ed _ZN3art3JNI17GetStaticMethodIDEP7_JNIEnvP7_jclassPKcS6_\nGetStringUTFChars is at  0xe39d06e5 _ZN3art3JNI17GetStringUTFCharsEP7_JNIEnvP8_jstringPh\nFindClass is at  0xe399ae5d _ZN3art3JNI9FindClassEP7_JNIEnvPKc\n*&#x2F;  \nfunction hookkill()\n&#123;\n        var module&#x3D;Process.findModuleByName(&quot;libc.so&quot;);\n        var killAddr&#x3D;module.findExportByName(&quot;kill&quot;);\n        Interceptor.replace(killAddr,new NativeCallback(function(args0,args1)&#123;\n            console.log(&quot;Interceptor.attach myfirstjniJNI args:&quot;,args0,args1);\n            \n            return 11;\n    \n        &#125;,&quot;int&quot;,[&quot;pointer&quot;,&quot;int&quot;]));\n       \n&#125;\nfunction hook_libart() &#123;\n    var symbols &#x3D; Module.enumerateSymbolsSync(&quot;libart.so&quot;);\n    var addrGetStringUTFChars &#x3D; null;\n    var addrNewStringUTF &#x3D; null;\n    var addrFindClass &#x3D; null;\n    var addrGetMethodID &#x3D; null;\n    var addrGetStaticMethodID &#x3D; null;\n    var addrGetFieldID &#x3D; null;\n    var addrGetStaticFieldID &#x3D; null;\n    var addrRegisterNatives &#x3D; null;\n    for (var i &#x3D; 0; i &lt; symbols.length; i++) &#123;\n        var symbol &#x3D; symbols[i];\n        if (symbol.name.indexOf(&quot;art&quot;) &gt;&#x3D; 0 &amp;&amp;\n            symbol.name.indexOf(&quot;JNI&quot;) &gt;&#x3D; 0 &amp;&amp;\n            symbol.name.indexOf(&quot;CheckJNI&quot;) &lt; 0\n        ) &#123;\n            if (symbol.name.indexOf(&quot;GetStringUTFChars&quot;) &gt;&#x3D; 0) &#123;\n                addrGetStringUTFChars &#x3D; symbol.address;\n                console.log(&quot;GetStringUTFChars is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;NewStringUTF&quot;) &gt;&#x3D; 0) &#123;\n                addrNewStringUTF &#x3D; symbol.address;\n                console.log(&quot;NewStringUTF is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;FindClass&quot;) &gt;&#x3D; 0) &#123;\n                addrFindClass &#x3D; symbol.address;\n                console.log(&quot;FindClass is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;GetMethodID&quot;) &gt;&#x3D; 0) &#123;\n                addrGetMethodID &#x3D; symbol.address;\n                console.log(&quot;GetMethodID is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;GetStaticMethodID&quot;) &gt;&#x3D; 0) &#123;\n                addrGetStaticMethodID &#x3D; symbol.address;\n                console.log(&quot;GetStaticMethodID is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;GetFieldID&quot;) &gt;&#x3D; 0) &#123;\n                addrGetFieldID &#x3D; symbol.address;\n                console.log(&quot;GetFieldID is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;GetStaticFieldID&quot;) &gt;&#x3D; 0) &#123;\n                addrGetStaticFieldID &#x3D; symbol.address;\n                console.log(&quot;GetStaticFieldID is at &quot;, symbol.address, symbol.name);\n            &#125; else if (symbol.name.indexOf(&quot;RegisterNatives&quot;) &gt;&#x3D; 0) &#123;\n                addrRegisterNatives &#x3D; symbol.address;\n                console.log(&quot;RegisterNatives is at &quot;, symbol.address, symbol.name);\n            &#125;\n        &#125;\n    &#125;\n\n    if (addrGetStringUTFChars !&#x3D; null) &#123;\n        Interceptor.attach(addrGetStringUTFChars, &#123;\n            onEnter: function (args) &#123;&#125;,\n            onLeave: function (retval) &#123;\n                if (retval !&#x3D; null) &#123;\n                    var bytes &#x3D; Memory.readCString(retval);\n                    console.log(&quot;[GetStringUTFChars] result:&quot; + bytes);\n                &#125;\n            &#125;\n        &#125;);\n    &#125;\n    if (addrNewStringUTF !&#x3D; null) &#123;\n        Interceptor.attach(addrNewStringUTF, &#123;\n            onEnter: function (args) &#123;\n                if (args[1] !&#x3D; null) &#123;\n                    var string &#x3D; Memory.readCString(args[1]);\n                    console.log(&quot;[NewStringUTF] bytes:&quot; + string);\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n    if (addrFindClass !&#x3D; null) &#123;\n        Interceptor.attach(addrFindClass, &#123;\n            onEnter: function (args) &#123;\n                if (args[1] !&#x3D; null) &#123;\n                    var name &#x3D; Memory.readCString(args[1]);\n                    console.log(&quot;[FindClass] name:&quot; + name);\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n    if (addrGetMethodID !&#x3D; null) &#123;\n        Interceptor.attach(addrGetMethodID, &#123;\n            onEnter: function (args) &#123;\n                if (args[2] !&#x3D; null) &#123;\n                    var name &#x3D; Memory.readCString(args[2]);\n                    if (args[3] !&#x3D; null) &#123;\n                        var sig &#x3D; Memory.readCString(args[3]);\n                        console.log(&quot;[GetMethodID] name:&quot; + name + &quot;, sig:&quot; + sig);\n                    &#125; else &#123;\n                        console.log(&quot;[GetMethodID] name:&quot; + name);\n                    &#125;\n\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n    if (addrGetStaticMethodID !&#x3D; null) &#123;\n        Interceptor.attach(addrGetStaticMethodID, &#123;\n            onEnter: function (args) &#123;\n                if (args[2] !&#x3D; null) &#123;\n                    var name &#x3D; Memory.readCString(args[2]);\n                    if (args[3] !&#x3D; null) &#123;\n                        var sig &#x3D; Memory.readCString(args[3]);\n                        console.log(&quot;[GetStaticMethodID] name:&quot; + name + &quot;, sig:&quot; + sig);\n                    &#125; else &#123;\n                        console.log(&quot;[GetStaticMethodID] name:&quot; + name);\n                    &#125;\n\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n    if (addrGetFieldID !&#x3D; null) &#123;\n        Interceptor.attach(addrGetFieldID, &#123;\n            onEnter: function (args) &#123;\n                if (args[2] !&#x3D; null) &#123;\n                    var name &#x3D; Memory.readCString(args[2]);\n                    if (args[3] !&#x3D; null) &#123;\n                        var sig &#x3D; Memory.readCString(args[3]);\n                        console.log(&quot;[GetFieldID] name:&quot; + name + &quot;, sig:&quot; + sig);\n                    &#125; else &#123;\n                        console.log(&quot;[GetFieldID] name:&quot; + name);\n                    &#125;\n\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n    if (addrGetStaticFieldID !&#x3D; null) &#123;\n        Interceptor.attach(addrGetStaticFieldID, &#123;\n            onEnter: function (args) &#123;\n                if (args[2] !&#x3D; null) &#123;\n                    var name &#x3D; Memory.readCString(args[2]);\n                    if (args[3] !&#x3D; null) &#123;\n                        var sig &#x3D; Memory.readCString(args[3]);\n                        console.log(&quot;[GetStaticFieldID] name:&quot; + name + &quot;, sig:&quot; + sig);\n                    &#125; else &#123;\n                        console.log(&quot;[GetStaticFieldID] name:&quot; + name);\n                    &#125;\n\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n\n    if (addrRegisterNatives !&#x3D; null) &#123;\n        Interceptor.attach(addrRegisterNatives, &#123;\n            onEnter: function (args) &#123;\n                console.log(&quot;[RegisterNatives] method_count:&quot;, args[3]);\n                var env &#x3D; args[0];\n                var java_class &#x3D; args[1];\n                var class_name &#x3D; Java.vm.tryGetEnv().getClassName(java_class);\n\n                var methods_ptr &#x3D; ptr(args[2]);\n\n                var method_count &#x3D; parseInt(args[3]);\n                for (var i &#x3D; 0; i &lt; method_count; i++) &#123;\n                    var name_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3));\n                    var sig_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize));\n                    var fnPtr_ptr &#x3D; Memory.readPointer(methods_ptr.add(i * Process.pointerSize * 3 + Process.pointerSize * 2));\n\n                    var name &#x3D; Memory.readCString(name_ptr);\n                    var sig &#x3D; Memory.readCString(sig_ptr);\n                    var find_module &#x3D; Process.findModuleByAddress(fnPtr_ptr);\n                    console.log(&quot;[RegisterNatives] java_class:&quot;, class_name, &quot;name:&quot;, name, &quot;sig:&quot;, sig, &quot;fnPtr:&quot;, fnPtr_ptr, &quot;module_name:&quot;, find_module.name, &quot;module_base:&quot;, find_module.base, &quot;offset:&quot;, ptr(fnPtr_ptr).sub(find_module.base));\n\n                &#125;\n            &#125;,\n            onLeave: function (retval) &#123;&#125;\n        &#125;);\n    &#125;\n&#125;\nfunction main()\n&#123;\n    hookkill();\n    hook_libart();\n&#125;\nsetImmediate(main);\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>hook效果，哦对，最好用attach方式，毕竟hook是libc的函数，肯定还有其他地方会hook到，为了避免太多无用信息，所以选择attach</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">frida -UF com.kanxue.test -l hook_art.js --no-pause<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<p><img src=\"https://raw.githubusercontent.com/YenKoc/YenKoc_tuchuang/main/images20210407101555.png\" alt=\"image-20210407101612137\"></p>\n<p>逻辑就很清晰了，非常nice。</p>\n","feature":null,"text":"脱壳发现加了数字壳，直接用frida-的dexdump或者寒冰大佬的fart脱，就完事了，我这里还是比较喜欢objection搭配frida-dexdump插件的方式，比较方便，对这种没抽取的壳，也完全足够了，直接操作 从内存中dump下了，三个dex，命令行输入grep -ri...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"app实战","slug":"app实战","count":2,"path":"api/categories/app实战.json"}],"tags":[{"name":"d2c","slug":"d2c","count":1,"path":"api/tags/d2c.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%84%B1%E5%A3%B3\"><span class=\"toc-text\">脱壳</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90\"><span class=\"toc-text\">代码分析</span></a></li></ol>","author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""},"mapped":true,"prev_post":{"title":"2021虎符ctf","uid":"b0f886f319692d13d933a2573c7d3ea9","slug":"2021虎符ctf","date":"2021-04-07T14:43:37.000Z","updated":"2021-04-07T15:00:31.990Z","comments":true,"path":"api/articles/2021虎符ctf.json","keywords":null,"cover":null,"text":"1. code通过去观察代码逻辑，发现是先初始化出一个二维数组，然后开始取字符，不过每行中的列数为字符的ascii码值时，而取出来为下一行的行数，再填充回去，而v7那个循环，要想成功的条件，就是必须每次都找到下一行的行数，那么其实flag就是输入的前14位字符，直接提交 2. g...","link":"","photos":[],"count_time":{"symbolsCount":"3.4k","symbolsTime":"3 mins."},"categories":[{"name":"writeup","slug":"writeup","count":7,"path":"api/categories/writeup.json"}],"tags":[{"name":"reverse","slug":"reverse","count":9,"path":"api/tags/reverse.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}},"next_post":{"title":"ida插件_traceNatives剖析","uid":"da27febfe9a3ffe7e8fc2063f78d23df","slug":"ida插件-traceNatives剖析","date":"2021-03-29T13:01:59.000Z","updated":"2021-04-19T13:33:08.980Z","comments":true,"path":"api/articles/ida插件-traceNatives剖析.json","keywords":null,"cover":"https://www.wahaotu.com/uploads/allimg/202009/1600175614578817.jpg","text":"前言前几天在肉丝朋友圈看到了龙哥的新作，一个名叫trace_native的ida插件项目，我出于好奇就想看看源码，发现好想原理也不难，不过提升了效率，还是很不错的 源码剖析import os from idaapi import plugin_t from idaapi impo...","link":"","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"ida插件","slug":"ida插件","count":2,"path":"api/categories/ida插件.json"}],"tags":[{"name":"ida插件","slug":"ida插件","count":2,"path":"api/tags/ida插件.json"}],"author":{"name":"YenKoc","avatar":"https://avatars.githubusercontent.com/u/52554268?s=400&u=e21e2b4ac372eaf3c2bc9c720c1ac24f974e936a&v=4","link":""}}}